<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>METAMOB - Crypto Collective</title>
    <link rel="icon" href="https://ipfs.io/ipfs/bafkreighn5razgixe6qiylmnmwmb6qhtpjmczzmhmqx3ghzduxgtyu3w64" type="image/x-icon" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@100;200;300;400;500;600;700;800&display=swap');

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'JetBrains Mono', monospace;
        font-weight: 500;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        overflow-x: hidden;
        transition: background-color 0.5s ease, color 0.5s ease;
        font-size: 14px;
        line-height: 1.6;
      }

      #bg-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
      }

      #logo-canvas {
        width: 72px;
        height: 72px;
        display: block;
      }

      .navbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        backdrop-filter: blur(15px);
        transition: background-color 0.5s ease;
        border-bottom: 1px solid rgba(138, 43, 226, 0.3);
      }

      .nav-link {
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 0.5rem 1rem;
        font-family: 'JetBrains Mono', monospace;
        font-weight: 300;
        letter-spacing: 0.15em;
        text-transform: uppercase;
        font-size: 0.7rem;
        text-shadow: 0 0 10px currentColor;
      }

      .nav-link:hover {
        transform: scale(1.1);
        text-shadow: 0 0 20px currentColor;
      }

      .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        height: 2px;
        background: linear-gradient(90deg, transparent, #8a2be2, #ff00ff, #8a2be2, transparent);
        animation: glowLine 2s ease-in-out infinite;
      }

      @keyframes glowLine {
        0%,
        100% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
          box-shadow: 0 0 10px #8a2be2;
        }
      }

      .color-slider {
        width: 45px;
        height: 15px;
        appearance: none;
        outline: none;
        cursor: pointer;
        border-radius: 1px;
        background: #ffffff;
        border: 1px solid black;
      }

      .color-slider::-webkit-slider-thumb {
        appearance: none;
        width: 15px;
        height: 20px;
        border-radius: 2px;
        cursor: pointer;
        box-shadow: 0 0 15px rgba(138, 43, 226, 1), 0 0 30px rgba(138, 43, 226, 0.5);
        background: linear-gradient(135deg, #8a2be2, #ff00ff);
        margin-top: -2.5px;
      }

      .color-slider::-moz-range-thumb {
        width: 15px;
        height: 20px;
        border-radius: 2px;
        cursor: pointer;
        box-shadow: 0 0 15px rgba(138, 43, 226, 1);
        border: none;
        background: linear-gradient(135deg, #8a2be2, #ff00ff);
      }

      .dropdown {
        position: relative;
        display: inline-block;
      }

      .dropdown-content {
        display: none;
        position: absolute;
        min-width: 180px;
        box-shadow: 0px 8px 32px rgba(0, 0, 0, 0.5);
        z-index: 1;
        border-radius: 8px;
        overflow: hidden;
        backdrop-filter: blur(20px);
        border: 1px solid rgba(138, 43, 226, 0.3);
        transition: background-color 0.5s ease;
      }

      .dropdown-content.show {
        display: block;
        animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-15px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .dropdown-item {
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        border-bottom: 1px solid rgba(138, 43, 226, 0.15);
        font-family: 'JetBrains Mono', monospace;
        font-weight: 500;
        font-size: 0.65rem;
        letter-spacing: 0.08em;
      }

      .dropdown-item:hover {
        background: linear-gradient(90deg, rgba(138, 43, 226, 0.2), rgba(255, 0, 255, 0.2));
        padding-left: 20px;
      }

      .section {
        min-height: 100vh;
        padding: 120px 20px 60px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: background-color 0.5s ease;
        position: relative;
      }

      /* ensure bottom UI (fixed footer) doesn't cover content */
      body {
        padding-bottom: 72px;
      }

      @media (max-width: 768px) {
        body {
          padding-bottom: 96px;
        }
      }

      .section-content {
        max-width: 1200px;
        width: 100%;
        opacity: 0;
        transform: translateY(50px);
      }

      .section-content.visible {
        animation: fadeInUp 0.8s ease forwards;
      }

      @keyframes fadeInUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .btn {
        padding: 10px 24px;
        border-radius: 0;
        font-family: 'JetBrains Mono', monospace;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        font-size: 0.6rem;
        background: transparent;
        position: relative;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(138, 43, 226, 0.2);
      }

      .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(138, 43, 226, 0.3), transparent);
        transition: left 0.5s ease;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 30px rgba(138, 43, 226, 0.6), 0 0 60px rgba(255, 0, 255, 0.3);
      }

      /* ============================================
           IMPROVED HAMBURGER MENU
           ============================================ */
      .hamburger {
        display: none;
        flex-direction: column;
        cursor: pointer;
        padding: 10px;
        z-index: 1002;
        position: relative;
        width: 40px;
        height: 40px;
        justify-content: center;
        align-items: center;
      }

      .hamburger span {
        width: 28px;
        height: 3px;
        margin: 3px 0;
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        box-shadow: 0 0 10px currentColor;
        border-radius: 2px;
        transform-origin: center;
      }

      .hamburger.active span:nth-child(1) {
        transform: rotate(45deg) translate(6px, 6px);
      }

      .hamburger.active span:nth-child(2) {
        opacity: 0;
        transform: scaleX(0);
      }

      .hamburger.active span:nth-child(3) {
        transform: rotate(-45deg) translate(6px, -6px);
      }

      /* ============================================
           FULLSCREEN MOBILE MENU OVERLAY
           ============================================ */
      .mobile-menu-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 999;
        backdrop-filter: blur(25px);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.4s ease, visibility 0.4s ease;
      }

      .mobile-menu-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .mobile-menu-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        padding: 100px 30px 50px;
        transform: translateY(30px);
        opacity: 0;
        transition: transform 0.5s ease 0.1s, opacity 0.5s ease 0.1s;
      }

      .mobile-menu-overlay.active .mobile-menu-content {
        transform: translateY(0);
        opacity: 1;
      }

      .mobile-nav-link {
        display: block;
        padding: 20px 40px;
        font-family: 'JetBrains Mono', monospace;
        font-weight: 300;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        font-size: 1.2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        opacity: 0;
        transform: translateX(-30px);
      }

      .mobile-menu-overlay.active .mobile-nav-link {
        opacity: 1;
        transform: translateX(0);
      }

      .mobile-nav-link:nth-child(1) {
        transition-delay: 0.15s;
      }
      .mobile-nav-link:nth-child(2) {
        transition-delay: 0.2s;
      }
      .mobile-nav-link:nth-child(3) {
        transition-delay: 0.25s;
      }
      .mobile-nav-link:nth-child(4) {
        transition-delay: 0.3s;
      }
      .mobile-nav-link:nth-child(5) {
        transition-delay: 0.35s;
      }
      .mobile-nav-link:nth-child(6) {
        transition-delay: 0.4s;
      }

      .mobile-nav-link::before {
        content: '‚óÜ';
        position: absolute;
        left: 10px;
        opacity: 0;
        transform: translateX(-10px);
        transition: all 0.3s ease;
        font-size: 0.6em;
      }

      .mobile-nav-link:hover::before,
      .mobile-nav-link.active::before {
        opacity: 1;
        transform: translateX(0);
      }

      .mobile-nav-link:hover {
        letter-spacing: 0.35em;
        text-shadow: 0 0 30px currentColor;
      }

      .mobile-nav-link.active {
        text-shadow: 0 0 20px currentColor;
      }

      .mobile-menu-controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        margin-top: 40px;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s ease 0.4s;
      }

      .mobile-menu-overlay.active .mobile-menu-controls {
        opacity: 1;
        transform: translateY(0);
      }

      .mobile-slider-container {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .mobile-slider-label {
        font-size: 0.6rem;
        letter-spacing: 0.15em;
        opacity: 0.7;
      }

      .mobile-buttons {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
      }

      /* Desktop nav-links */
      .nav-links-desktop {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* ============================================
           RESPONSIVE BREAKPOINTS
           ============================================ */
      @media (max-width: 1024px) {
        .nav-links-desktop {
          display: none;
        }

        .hamburger {
          display: flex;
        }

        .mobile-menu-overlay {
          display: block;
        }

        .section {
          padding: 100px 20px 50px;
        }

        #logo-canvas {
          width: 56px;
          height: 56px;
        }

        .navbar .font-bold {
          font-size: 1.25rem !important;
        }
      }

      @media (max-width: 768px) {
        .section {
          padding: 90px 15px 40px;
          min-height: auto;
        }

        .gothic-text {
          font-size: 2rem !important;
          letter-spacing: 0.2em;
        }

        .gothic-text::before,
        .gothic-text::after {
          display: none;
        }

        .grid-container {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .card {
          padding: 20px;
        }

        #logo-canvas {
          width: 48px;
          height: 48px;
        }

        .navbar .font-bold {
          font-size: 1.1rem !important;
        }

        .mobile-nav-link {
          font-size: 1rem;
          padding: 15px 30px;
        }
      }

      @media (max-width: 480px) {
        .section {
          padding: 80px 12px 30px;
        }

        .gothic-text {
          font-size: 1.5rem !important;
          letter-spacing: 0.15em;
        }

        .card {
          padding: 15px;
        }

        .btn {
          padding: 8px 16px;
          font-size: 0.55rem;
        }

        #logo-canvas {
          width: 40px;
          height: 40px;
        }

        .navbar .font-bold {
          font-size: 1rem !important;
        }

        .mobile-nav-link {
          font-size: 0.9rem;
          padding: 12px 20px;
        }
      }

      .network-icon {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 10px;
        box-shadow: 0 0 10px currentColor;
      }

      .wallet-address {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.6rem;
        letter-spacing: 0.05em;
        font-weight: 400;
      }

      .glow-text {
        text-shadow: 0 0 20px currentColor, 0 0 40px rgba(138, 43, 226, 0.5), 0 0 60px rgba(255, 0, 255, 0.3);
      }

      .gothic-text {
        font-family: 'JetBrains Mono', monospace;
        text-transform: uppercase;
        letter-spacing: 0.35em;
        position: relative;
        font-weight: 200;
      }

      .gothic-text::before {
        content: '‚óÜ';
        position: absolute;
        left: -25px;
        opacity: 0.5;
        font-size: 0.6em;
        animation: pulse 2s ease-in-out infinite;
      }

      .gothic-text::after {
        content: '‚óÜ';
        position: absolute;
        right: -25px;
        opacity: 0.5;
        font-size: 0.6em;
        animation: pulse 2s ease-in-out infinite 1s;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 0.3;
        }
        50% {
          opacity: 0.8;
        }
      }

      .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 30px;
        margin-top: 40px;
      }

      .card {
        border-radius: 8px;
        padding: 30px;
        backdrop-filter: blur(10px);
        transition: all 0.4s ease;
        border: 1px solid rgba(138, 43, 226, 0.3);
        position: relative;
        overflow: hidden;
      }

      .card::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #8a2be2, #ff00ff, #00ffff, #8a2be2);
        background-size: 400% 400%;
        border-radius: 8px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: -1;
        animation: gradientBorder 3s ease infinite;
      }

      @keyframes gradientBorder {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      .card:hover::before {
        opacity: 0.3;
      }

      .card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 60px rgba(138, 43, 226, 0.4), 0 0 100px rgba(255, 0, 255, 0.2);
      }

      @media (max-width: 768px) {
        .card:hover {
          transform: translateY(-4px) scale(1.01);
        }
      }

      /* CRT Scanline Effect */
      .crt-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
        opacity: 0.03;
        background: repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0.15) 1px, transparent 1px, transparent 2px);
      }

      /* Cyberpunk Decorations */
      .cyber-line {
        position: absolute;
        background: linear-gradient(90deg, transparent, #8a2be2, transparent);
        height: 1px;
        animation: scan 4s linear infinite;
      }

      @keyframes scan {
        0% {
          transform: translateX(-100%);
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
        100% {
          transform: translateX(100vw);
          opacity: 0;
        }
      }

      /* Mobile-specific touch feedback */
      @media (hover: none) and (pointer: coarse) {
        .nav-link:active,
        .mobile-nav-link:active,
        .btn:active {
          transform: scale(0.95);
        }

        .card:active {
          transform: scale(0.98);
        }
      }

      /* Prevent text selection on mobile menu */
      .mobile-menu-overlay {
        -webkit-user-select: none;
        user-select: none;
      }

      /* Smooth scrolling for the whole page */
      html {
        scroll-behavior: smooth;
      }

      /* Hide scrollbar during menu open on mobile */
      body.menu-open {
        overflow: hidden;
      }

      /* ============================================
           EVENTS CALENDAR (7 DAYS / 24H / 1H SLOTS)
           Compact, no internal scrolling
           ============================================ */
      .events-calendar {
        width: 100%;
      }

      /* 8 columns total: Time + 7 Days. We use 12.5% (1/8) for each to ensure perfect alignment. */
      .events-head {
        display: grid;
        grid-template-columns: 12.5% repeat(7, 12.5%);
        gap: 0;
        border: 1px solid rgba(138, 43, 226, 0.25);
        border-bottom: 0;
        overflow: hidden;
      }

      .events-head .corner {
        height: 38px;
        border-right: 1px solid rgba(138, 43, 226, 0.18);
        background: rgba(255, 255, 255, 0.03);
      }

      .events-head .day {
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 8px;
        font-size: 0.55rem;
        letter-spacing: 0.12em;
        border-right: 1px solid rgba(138, 43, 226, 0.18);
        background: rgba(255, 255, 255, 0.03);
        min-width: 0;
      }

      .events-head .day:last-child {
        border-right: 0;
      }

      .events-head .day .date {
        opacity: 0.7;
        letter-spacing: 0.05em;
      }

      .events-grid {
        position: relative;
        display: grid;
        grid-template-columns: 12.5% 87.5%;
        border: 1px solid rgba(138, 43, 226, 0.25);
        overflow: hidden;
        height: 480px; /* 24h * 20px */
      }

      .events-time-col {
        position: sticky;
        left: 0;
        z-index: 4;
        background: rgba(255, 255, 255, 0.05);
        border-right: 1px solid rgba(138, 43, 226, 0.18);
      }

      .events-time-label {
        height: 20px;
        padding: 0 6px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        font-size: 0.5rem;
        opacity: 0.9;
        letter-spacing: 0.08em;
        border-bottom: 1px solid rgba(138, 43, 226, 0.05);
        white-space: nowrap;
      }

      .events-days {
        position: relative;
        display: grid;
        grid-template-columns: repeat(7, 14.2857%); /* Each is 1/7th of 87.5%, which is 12.5% of the total */
        width: 100%;
        height: 100%;
      }

      .events-day {
        position: relative;
        border-right: 1px solid rgba(138, 43, 226, 0.18);
        background: rgba(255, 255, 255, 0.02);
        min-width: 0;
      }

      .events-day:last-child {
        border-right: 0;
      }

      .events-day .cell {
        height: 20px; /* 1h slot */
        border-bottom: 1px solid rgba(138, 43, 226, 0.15);
      }

      .event-block {
        position: absolute;
        left: 6px;
        right: 6px;
        border: 1px solid currentColor;
        background: rgba(0, 255, 255, 0.08);
        box-shadow: 0 0 18px rgba(0, 255, 255, 0.12);
        padding: 6px 8px;
        font-size: 0.62rem;
        letter-spacing: 0.06em;
        text-transform: none;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .event-block .title {
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        font-size: 0.55rem;
      }

      .event-block:hover {
        transform: translateY(-1px);
        box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
      }

      /* ============================================
           EVENT DETAILS MODAL
           ============================================ */
      .event-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .event-modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .event-modal {
        background: var(--bg-color, #0a0a0f);
        border: 1px solid rgba(138, 43, 226, 0.5);
        border-radius: 8px;
        padding: 30px;
        max-width: 500px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        transform: scale(0.9);
        transition: transform 0.3s ease;
        box-shadow: 0 0 60px rgba(138, 43, 226, 0.4);
      }

      .event-modal-overlay.active .event-modal {
        transform: scale(1);
      }

      .event-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(138, 43, 226, 0.3);
      }

      .event-modal-title {
        font-size: 1.2rem;
        font-weight: 700;
        letter-spacing: 0.15em;
        text-transform: uppercase;
      }

      .event-modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: currentColor;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .event-modal-close:hover {
        transform: scale(1.2);
        text-shadow: 0 0 20px currentColor;
      }

      .event-modal-info {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .event-modal-row {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .event-modal-label {
        font-size: 0.7rem;
        opacity: 0.7;
        letter-spacing: 0.1em;
        text-transform: uppercase;
      }

      .event-modal-value {
        font-size: 0.9rem;
        font-weight: 500;
        letter-spacing: 0.05em;
      }

      .event-modal-description {
        margin-top: 10px;
        padding-top: 15px;
        border-top: 1px solid rgba(138, 43, 226, 0.2);
      }

      .event-modal-description-text {
        font-size: 0.85rem;
        line-height: 1.6;
        text-transform: none;
        white-space: pre-wrap;
      }

      /* mobile improvements for calendar (keep no-scroll layout) */
      @media (max-width: 768px) {
        .events-head {
          grid-template-columns: 12.5% repeat(7, 12.5%);
        }
        .events-grid {
          grid-template-columns: 12.5% 87.5%;
          height: 480px;
        }
        .events-time-label {
          font-size: 0.45rem;
          padding: 0 4px;
        }
        .events-head .day {
          padding: 0 6px;
          font-size: 0.5rem;
        }
        .event-block {
          left: 4px;
          right: 4px;
          padding: 4px 6px;
        }
        .event-modal {
          padding: 20px;
          margin: 10px;
        }
      }

      /* ============================================
           FOOTER
           ============================================ */
      .site-footer {
        width: 100%;
        padding: 14px 20px;
        border-top: 1px solid rgba(138, 43, 226, 0.35);
        backdrop-filter: blur(14px);
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 900; /* above bg canvas, below navbar/overlays */
      }

      .site-footer-inner {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 14px;
      }

      .footer-copy {
        font-size: 0.6rem;
        letter-spacing: 0.14em;
        opacity: 0.9;
      }

      .footer-links {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .social {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 14px;
      }

      .icon {
        display: inline-block;
        height: 24px;
        width: 24px;
        object-fit: contain;
        filter: drop-shadow(0 0 10px rgba(0, 255, 255, 0.18));
        transition: transform 0.2s ease, filter 0.2s ease, opacity 0.2s ease;
        opacity: 0.92;
      }

      #socials a:hover .icon {
        transform: translateY(-1px) scale(1.08);
        filter: drop-shadow(0 0 18px rgba(0, 255, 255, 0.35));
        opacity: 1;
      }

      .footer-link {
        font-size: 0.6rem;
        letter-spacing: 0.15em;
        cursor: pointer;
        opacity: 0.85;
        transition: all 0.25s ease;
        text-shadow: 0 0 12px currentColor;
        background: transparent;
        border: none;
        padding: 6px 8px;
      }

      .footer-link:hover {
        opacity: 1;
        transform: translateY(-1px);
        text-shadow: 0 0 24px currentColor;
      }

      @media (max-width: 768px) {
        .site-footer-inner {
          flex-direction: column;
          align-items: flex-start;
        }
      }

      /* ============================================
           LEGAL TEXT MODAL (PRIVACY / TERMS)
           ============================================ */
      .legal-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        z-index: 2100;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .legal-modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .legal-modal {
        background: var(--bg-color, #0a0a0f);
        border: 1px solid rgba(138, 43, 226, 0.55);
        border-radius: 8px;
        padding: 28px;
        max-width: 760px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        transform: scale(0.92);
        transition: transform 0.3s ease;
        box-shadow: 0 0 80px rgba(138, 43, 226, 0.35);
      }

      .legal-modal-overlay.active .legal-modal {
        transform: scale(1);
      }

      .legal-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-bottom: 14px;
        padding-bottom: 14px;
        border-bottom: 1px solid rgba(138, 43, 226, 0.25);
      }

      .legal-modal-title {
        font-size: 1.05rem;
        font-weight: 700;
        letter-spacing: 0.16em;
      }

      .legal-modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: currentColor;
        padding: 0;
        width: 34px;
        height: 34px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .legal-modal-close:hover {
        transform: scale(1.15);
        text-shadow: 0 0 20px currentColor;
      }

      .legal-modal-body {
        font-size: 0.8rem;
        line-height: 1.75;
        text-transform: none;
        white-space: pre-wrap;
        opacity: 0.95;
      }

      .wallet-modal-body {
        display: grid;
        gap: 12px;
        font-size: 0.8rem;
        line-height: 1.5;
        text-transform: none;
      }

      /* Compact account form layout */
      .wallet-field-row {
        display: grid;
        grid-template-columns: minmax(80px, 0.9fr) minmax(0, 2.4fr) auto;
        align-items: center;
        gap: 8px;
      }

      @media (max-width: 640px) {
        .wallet-field-row {
          grid-template-columns: minmax(86px, 0.95fr) minmax(0, 2.1fr) auto;
          gap: 6px;
        }
      }

      .wallet-field-label {
        font-size: 0.7rem;
        letter-spacing: 0.12em;
        opacity: 0.7;
        text-transform: uppercase;
        white-space: nowrap;
      }

      .wallet-field-input {
        width: 100%;
        border-radius: 4px;
        border: 1px solid rgba(138, 43, 226, 0.35);
        padding: 6px 8px;
        background: rgba(0, 0, 0, 0.2);
        color: inherit;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.78rem;
        letter-spacing: 0.03em;
      }

      .wallet-field-input:disabled {
        opacity: 0.7;
        background: rgba(0, 0, 0, 0.1);
      }

      .wallet-edit-btn {
        padding: 6px 10px;
        font-size: 0.65rem;
        letter-spacing: 0.12em;
        white-space: nowrap;
      }

      .wallet-phone-group {
        display: grid;
        grid-template-columns: minmax(96px, 0.9fr) minmax(0, 1.7fr);
        gap: 6px;
      }

      @media (max-width: 640px) {
        .wallet-phone-group {
          grid-template-columns: minmax(96px, 1fr) minmax(0, 1.6fr);
        }
      }

      .wallet-prefix-select {
        width: 100%;
        border-radius: 4px;
        border: 1px solid rgba(138, 43, 226, 0.35);
        padding: 6px 8px;
        background: rgba(0, 0, 0, 0.2);
        color: inherit;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.78rem;
      }

      .wallet-file-input {
        width: 100%;
        padding: 4px 0;
        font-size: 0.76rem;
      }

      /* Avatar upload (Account modal) */
      .wallet-avatar-row {
        display: grid;
        grid-template-columns: minmax(80px, 0.9fr) minmax(0, 2.4fr);
        gap: 8px;
        align-items: start;
      }

      @media (max-width: 640px) {
        .wallet-avatar-row {
          grid-template-columns: minmax(86px, 0.95fr) minmax(0, 2.1fr);
          gap: 6px;
        }
      }

      .wallet-avatar-meta {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .wallet-avatar-preview {
        width: 84px;
        height: 84px;
        border-radius: 10px;
        object-fit: cover;
        border: 1px solid rgba(138, 43, 226, 0.35);
        background: rgba(0, 0, 0, 0.15);
      }

      .wallet-avatar-url {
        display: none;
        font-size: 0.68rem;
        letter-spacing: 0.04em;
        opacity: 0.9;
        text-transform: none;
        word-break: break-all;
        line-height: 1.3;
      }

      .wallet-avatar-hint {
        font-size: 0.7rem;
        opacity: 0.75;
        text-transform: none;
        line-height: 1.4;
      }

      .wallet-metrics {
        display: grid;
        gap: 8px;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }

      .wallet-metric {
        border: 1px solid rgba(138, 43, 226, 0.35);
        padding: 10px 12px;
        border-radius: 8px;
        text-align: left;
        background: rgba(255, 255, 255, 0.02);
      }

      .wallet-metric .label {
        font-size: 0.65rem;
        letter-spacing: 0.1em;
        opacity: 0.7;
        margin-bottom: 4px;
      }

      .wallet-metric .value {
        font-size: 0.85rem;
        font-weight: 600;
      }

      .wallet-list {
        display: grid;
        gap: 6px;
      }

      .wallet-list li {
        list-style: none;
        padding: 8px 10px;
        border: 1px solid rgba(138, 43, 226, 0.25);
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .wallet-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .chat-window {
        border: 1px solid rgba(138, 43, 226, 0.25);
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 200px;
      }

      .chat-messages {
        flex: 1;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        background: rgba(255, 255, 255, 0.02);
      }

      .chat-input {
        display: flex;
        gap: 8px;
        padding: 10px;
        border-top: 1px solid rgba(138, 43, 226, 0.25);
      }

      .chat-input input {
        flex: 1;
        background: transparent;
        border: 1px solid rgba(138, 43, 226, 0.35);
        padding: 8px 10px;
        color: inherit;
        font-family: 'JetBrains Mono', monospace;
      }

      .ethos-modal-body {
        display: grid;
        gap: 18px;
        align-items: center;
      }

      @media (min-width: 768px) {
        .ethos-modal-body {
          grid-template-columns: 1.1fr 1fr;
        }
      }

      .ethos-modal-image {
        width: 100%;
        height: 240px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid currentColor;
        opacity: 0.85;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
      }

      .ethos-modal-text {
        font-size: 0.9rem;
        line-height: 1.7;
        opacity: 0.92;
        text-transform: none;
      }

      @media (max-width: 480px) {
        .legal-modal {
          padding: 18px;
        }
      }

      /* ============================================
           SHOP: PRODUCT MODALS
           ============================================ */
      .product-card {
        cursor: pointer;
      }
      .product-card:focus {
        outline: 2px solid currentColor;
        outline-offset: 3px;
      }

      /* Hide old inline price/buy rows (purchase happens in modals/details) */
      #mob-market .grid-container .flex.justify-between.items-center {
        display: none;
      }

      .product-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.82);
        backdrop-filter: blur(12px);
        z-index: 2200;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.25s ease, visibility 0.25s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 18px;
      }
      .product-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .product-modal {
        background: var(--bg-color, #0a0a0f);
        border: 1px solid rgba(138, 43, 226, 0.55);
        border-radius: 10px;
        width: 100%;
        max-width: 980px;
        max-height: 86vh;
        overflow: auto;
        box-shadow: 0 0 90px rgba(138, 43, 226, 0.35);
      }

      .product-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 18px 18px 14px;
        border-bottom: 1px solid rgba(138, 43, 226, 0.25);
      }
      .product-modal-title {
        font-size: 0.95rem;
        font-weight: 700;
        letter-spacing: 0.16em;
      }
      .product-modal-close {
        background: none;
        border: none;
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6rem;
        cursor: pointer;
        color: currentColor;
        transition: transform 0.2s ease;
      }
      .product-modal-close:hover {
        transform: scale(1.12);
      }

      .product-modal-body {
        padding: 16px 18px 20px;
      }

      .variant-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 14px;
      }

      .variant-tile {
        grid-column: span 12;
        border: 1px solid rgba(138, 43, 226, 0.35);
        border-radius: 10px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.03);
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }
      .variant-tile:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 40px rgba(0, 255, 255, 0.18);
      }

      .variant-img {
        width: 100%;
        height: 220px;
        object-fit: cover;
        display: block;
        filter: saturate(0.9) contrast(1.05);
      }

      .variant-meta {
        padding: 12px 14px 14px;
        display: grid;
        gap: 8px;
      }
      .variant-name {
        font-weight: 800;
        letter-spacing: 0.12em;
        font-size: 0.72rem;
      }
      .variant-desc {
        text-transform: none;
        font-size: 0.72rem;
        opacity: 0.9;
        line-height: 1.6;
      }
      .variant-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
      }
      .price-tag {
        font-weight: 800;
        letter-spacing: 0.12em;
      }

      @media (min-width: 768px) {
        .variant-tile {
          grid-column: span 6;
        }
        .variant-img {
          height: 240px;
        }
      }
      @media (min-width: 1024px) {
        .variant-tile {
          grid-column: span 4;
        }
      }

      /* Product Detail "page" */
      .product-detail {
        width: 100%;
        max-width: 1100px;
        max-height: 90vh;
        overflow: auto;
        border-radius: 12px;
        border: 1px solid rgba(138, 43, 226, 0.55);
        background: var(--bg-color, #0a0a0f);
        box-shadow: 0 0 110px rgba(138, 43, 226, 0.35);
      }

      .product-detail-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 16px 18px;
        border-bottom: 1px solid rgba(138, 43, 226, 0.25);
      }

      .product-detail-body {
        padding: 16px 18px 22px;
        display: grid;
        gap: 18px;
        grid-template-columns: 1fr;
      }

      @media (min-width: 900px) {
        .product-detail-body {
          grid-template-columns: 1.15fr 0.85fr;
        }
      }

      .detail-img {
        width: 100%;
        height: 360px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid rgba(138, 43, 226, 0.25);
      }

      .detail-title {
        font-size: 1.1rem;
        font-weight: 800;
        letter-spacing: 0.16em;
      }
      .detail-sub {
        opacity: 0.8;
        letter-spacing: 0.1em;
        font-size: 0.7rem;
      }
      .detail-text {
        text-transform: none;
        font-size: 0.82rem;
        line-height: 1.7;
        opacity: 0.95;
      }
      .spec-list {
        text-transform: none;
        font-size: 0.78rem;
        line-height: 1.6;
        opacity: 0.95;
      }
      .spec-list li {
        margin: 6px 0;
      }

      .toast {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 88px;
        z-index: 3000;
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid rgba(138, 43, 226, 0.6);
        backdrop-filter: blur(10px);
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 0.7rem;
        letter-spacing: 0.12em;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(-4px);
      }
    </style>
  </head>
  <body>
    <!-- CRT Overlay -->
    <div class="crt-overlay"></div>

    <!-- Three.js Background Canvas -->
    <canvas id="bg-canvas"></canvas>

    <!-- Event Details Modal -->
    <div class="event-modal-overlay" id="eventModalOverlay">
      <div class="event-modal" id="eventModal">
        <div class="event-modal-header">
          <h3 class="event-modal-title" id="modalTitle">EVENT DETAILS</h3>
          <button class="event-modal-close" id="modalClose">&times;</button>
        </div>
        <div class="event-modal-info">
          <div class="event-modal-row">
            <div class="event-modal-label">Title</div>
            <div class="event-modal-value" id="modalEventTitle"></div>
          </div>
          <div class="event-modal-row">
            <div class="event-modal-label">Time</div>
            <div class="event-modal-value" id="modalEventTime"></div>
          </div>
          <div class="event-modal-row">
            <div class="event-modal-label">Location</div>
            <div class="event-modal-value" id="modalEventLocation"></div>
          </div>
          <div class="event-modal-row event-modal-description">
            <div class="event-modal-label">Description</div>
            <div class="event-modal-description-text" id="modalEventDescription"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay">
      <div class="mobile-menu-content">
        <a class="mobile-nav-link active" data-section="ethos">Ethos</a>
        <a class="mobile-nav-link" data-section="mobmap">MobMap</a>
        <a class="mobile-nav-link" data-section="team">Team</a>
        <a class="mobile-nav-link" data-section="mob-market">Shop</a>
        <a class="mobile-nav-link" data-section="events">Events</a>
        <a class="mobile-nav-link" data-section="news">News</a>
        <a class="mobile-nav-link" data-section="partners">Partners</a>

        <div class="mobile-menu-controls">
          <div class="mobile-slider-container">
            <span class="mobile-slider-label">THEME</span>
            <input type="range" min="0" max="2" step="1" value="0" class="color-slider" id="mobileColorSlider" title="Toggle Theme" />
          </div>
          <div class="mobile-buttons">
            <button class="btn" id="mobileNetworkBtn"><span id="mobileCurrentNetwork">Base</span> ‚ñæ</button>
            <button class="btn" id="mobileConnectBtn">Connect</button>
            <div id="mobileWalletConnected" style="display: none">
              <button class="btn" id="mobileWalletMenuBtn"><span class="wallet-address" id="mobileWalletAddressShort">0x0000...0000</span> ‚ñæ</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <!-- Logo -->
        <div class="flex items-center gap-3">
          <canvas id="logo-canvas"></canvas>
          <span class="font-bold text-2xl glow-text">METAMOB</span>
        </div>

        <!-- Desktop Navigation Links -->
        <div class="nav-links-desktop" id="navLinksDesktop">
          <a class="nav-link active" data-section="ethos">Ethos</a>
          <a class="nav-link" data-section="mobmap">MobMap</a>
          <a class="nav-link" data-section="team">Team</a>
          <a class="nav-link" data-section="mob-market">Shop</a>
          <a class="nav-link" data-section="events">Events</a>
          <a class="nav-link" data-section="news">News</a>
          <a class="nav-link" data-section="partners">Partners</a>

          <!-- Color Toggle Slider -->
          <input type="range" min="0" max="2" step="1" value="0" class="color-slider ml-4" id="colorSlider" title="Toggle Theme" />

          <!-- Network Switch -->
          <div class="dropdown ml-2">
            <button class="btn" id="networkBtn"><span id="currentNetwork">Base</span> ‚ñæ</button>
            <div class="dropdown-content" id="networkDropdown">
              <div class="dropdown-item" data-network="Base"><span class="network-icon" style="background: #0052ff"></span>Base</div>
              <div class="dropdown-item" data-network="Linea"><span class="network-icon" style="background: #61dfff"></span>Linea</div>
              <div class="dropdown-item" data-network="Monad"><span class="network-icon" style="background: #8a2be2"></span>Monad</div>
              <div class="dropdown-item" data-network="Polygon"><span class="network-icon" style="background: #8247e5"></span>Polygon</div>
              <div class="dropdown-item" data-network="Solana"><span class="network-icon" style="background: #00ffa3"></span>Solana</div>
              <div class="dropdown-item" data-network="zkSync"><span class="network-icon" style="background: #8c8dfc"></span>zkSync</div>
            </div>
          </div>

          <!-- Connect Wallet Button -->
          <button class="btn" id="connectBtn">Connect Wallet</button>
          <div class="dropdown ml-2" id="walletDropdownContainer" style="display: none">
            <button class="btn" id="walletMenuBtn"><span class="wallet-address" id="walletAddressShort">0x0000...0000</span> ‚ñæ</button>
            <div class="dropdown-content" id="walletDropdown" style="right: 0">
              <div class="dropdown-item" data-action="account">üë§ Account</div>
              <div class="dropdown-item" data-action="settings">‚öôÔ∏è Settings</div>
              <div class="dropdown-item" data-action="chat">üí¨ Chat</div>
              <div class="dropdown-item" data-action="wallet">üí≥ Wallet</div>
              <div class="dropdown-item" data-action="logout">üö™ Logout</div>
            </div>
          </div>
        </div>

        <!-- Hamburger Menu -->
        <div class="hamburger" id="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
      <div class="cyber-line" style="top: 100%; width: 200px; animation-delay: 0s"></div>
    </nav>

    <!-- Ethos Section -->
    <section class="section" id="ethos">
      <div class="section-content">
        <h1 class="text-4xl md:text-6xl mb-6 glow-text gothic-text text-center" style="font-weight: 100">OUR ETHOS</h1>
        <p class="text-xs md:text-sm mb-8 text-center max-w-3xl mx-auto" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 0.03em; line-height: 1.8; text-transform: none">In the shadows of the eternal city, we forge the future of decentralized technology. Where blockchain meets urban innovation, our mission is to create a seamless web3 experience that empowers the underground and revolutionizes digital ownership.</p>
        <div class="mt-8 mb-6 text-center">
          <div id="metaMobMantrasTitle" class="text-sm md:text-base tracking-[0.3em] mb-2" style="font-family: 'JetBrains Mono', monospace; font-weight: 700; text-transform: uppercase">META MOB MANTRAS</div>
          <p id="metaMobMantrasQuote" class="text-xs md:text-sm italic max-w-3xl mx-auto" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; letter-spacing: 0.05em; line-height: 1.8; text-transform: none">"Honesty & Integrity is the new Meta. Connections are the currency that prints opportunity. Collaboration over Competition. We win as one."</p>
        </div>

        <div class="grid-container">
          <div class="card ethos-card" data-title="DECENTRALIZATION" data-text="True ownership and control in the hands of the community, forged in the fires of cryptographic revolution. We remove the middleman to ensure direct peer-to-peer interaction is the standard, not the exception.">
            <svg class="w-full h-32 md:h-48 mb-4" viewBox="0 0 400 300" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M 200 30 L 180 80 L 180 200 L 220 200 L 220 80 Z" opacity="0.4" />
              <path d="M 200 30 L 150 100 L 150 180 L 250 180 L 250 100 Z" opacity="0.3" />
              <path d="M 120 120 Q 120 60 200 30 Q 280 60 280 120" opacity="0.5" />
              <path d="M 200 30 L 200 10" opacity="0.7" stroke-width="2" />
              <path d="M 140 100 L 100 140" opacity="0.4" />
              <path d="M 260 100 L 300 140" opacity="0.4" />
              <circle cx="200" cy="120" r="25" opacity="0.6" />
              <circle cx="200" cy="120" r="15" opacity="0.7" />
              <line x1="200" y1="95" x2="200" y2="145" opacity="0.5" />
              <line x1="175" y1="120" x2="225" y2="120" opacity="0.5" />
            </svg>
            <h3 class="text-base md:text-lg mb-3" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 0.25em">DECENTRALIZATION</h3>
            <p class="text-xs" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 0.02em; line-height: 1.7; text-transform: none">True ownership and control in the hands of the community, forged in the fires of cryptographic revolution.</p>
          </div>
          <div class="card ethos-card" data-title="INNOVATION" data-text="Pushing boundaries with cutting-edge technology, creating solutions for tomorrow's darkest challenges. Our R&D wing focuses on next-gen primitives and abstract account implementations that simplify the complex.">
            <svg class="w-full h-32 md:h-48 mb-4" viewBox="0 0 400 300" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="150" y="50" width="100" height="200" opacity="0.3" />
              <rect x="160" y="60" width="80" height="180" opacity="0.4" />
              <line x1="180" y1="60" x2="180" y2="20" opacity="0.7" />
              <line x1="220" y1="60" x2="220" y2="20" opacity="0.7" />
              <line x1="200" y1="60" x2="200" y2="10" opacity="0.8" stroke-width="2" />
              <line x1="160" y1="80" x2="200" y2="120" opacity="0.5" />
              <line x1="200" y1="80" x2="160" y2="120" opacity="0.5" />
              <line x1="200" y1="140" x2="240" y2="180" opacity="0.5" />
              <line x1="240" y1="140" x2="200" y2="180" opacity="0.5" />
              <rect x="170" y="100" width="15" height="15" opacity="0.4" />
              <rect x="200" y="100" width="15" height="15" opacity="0.4" />
              <rect x="170" y="130" width="15" height="15" opacity="0.4" />
              <rect x="200" y="130" width="15" height="15" opacity="0.4" />
            </svg>
            <h3 class="text-base md:text-lg mb-3" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 0.25em">INNOVATION</h3>
            <p class="text-xs" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 0.02em; line-height: 1.7; text-transform: none">Pushing boundaries with cutting-edge technology, creating solutions for tomorrow's darkest challenges.</p>
          </div>
          <div class="card ethos-card" data-title="COMMUNITY" data-text="Building together in the shadows. Our strength lies in our diverse, connected underground network. Every member of the METAMOB contributes to the shared vision of a truly free and open web.">
            <svg class="w-full h-32 md:h-48 mb-4" viewBox="0 0 400 300" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="200" cy="80" r="20" opacity="0.7" />
              <circle cx="100" cy="150" r="15" opacity="0.5" />
              <circle cx="300" cy="150" r="15" opacity="0.5" />
              <circle cx="150" cy="220" r="15" opacity="0.5" />
              <circle cx="250" cy="220" r="15" opacity="0.5" />
              <line x1="200" y1="80" x2="100" y2="150" opacity="0.6" />
              <line x1="200" y1="80" x2="300" y2="150" opacity="0.6" />
              <line x1="100" y1="150" x2="150" y2="220" opacity="0.5" />
              <line x1="300" y1="150" x2="250" y2="220" opacity="0.5" />
              <line x1="150" y1="220" x2="250" y2="220" opacity="0.5" />
              <line x1="100" y1="150" x2="300" y2="150" opacity="0.4" />
              <circle cx="200" cy="80" r="8" opacity="0.9" />
            </svg>
            <h3 class="text-base md:text-lg mb-3" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 0.25em">COMMUNITY</h3>
            <p class="text-xs" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 0.02em; line-height: 1.7; text-transform: none">Building together in the shadows. Our strength lies in our diverse, connected underground network.</p>
          </div>

          <!-- Second Row of Ethos Cards -->
          <div class="card ethos-card" data-title="SECURITY" data-text="Hardened from the ground up. We utilize battle-tested cryptographic standards and rigorous auditing to ensure your assets remain in your control. Trust but verify.">
            <svg class="w-full h-32 md:h-48 mb-4" viewBox="0 0 400 300" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M 150 120 L 150 220 Q 200 250 250 220 L 250 120 Z" opacity="0.4" />
              <circle cx="200" cy="160" r="20" opacity="0.5" />
              <line x1="200" y1="160" x2="200" y2="190" opacity="0.6" />
              <path d="M 170 120 L 170 100 Q 200 70 230 100 L 230 120" opacity="0.7" />
            </svg>
            <h3 class="text-base md:text-lg mb-3" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 0.25em">SECURITY</h3>
            <p class="text-xs" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 0.02em; line-height: 1.7; text-transform: none">Hardened protocols for a hostile environment. Protecting your digital sovereignty.</p>
          </div>
          <div class="card ethos-card" data-title="TRANSPARENCY" data-text="Open source is our mandate. All core protocols are verifiable on-chain, ensuring that the code is the only law. We operate in the light of absolute accountability.">
            <svg class="w-full h-32 md:h-48 mb-4" viewBox="0 0 400 300" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="200" cy="150" r="60" opacity="0.3" />
              <circle cx="200" cy="150" r="30" opacity="0.5" />
              <path d="M 140 150 Q 200 100 260 150 Q 200 200 140 150" opacity="0.6" />
              <circle cx="200" cy="150" r="10" opacity="0.8" />
            </svg>
            <h3 class="text-base md:text-lg mb-3" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 0.25em">TRANSPARENCY</h3>
            <p class="text-xs" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 0.02em; line-height: 1.7; text-transform: none">Verifiable code for a trustless world. The architecture of absolute accountability.</p>
          </div>
          <div class="card ethos-card" data-title="SOVEREIGNTY" data-text="You are the ultimate authority. Our tools are designed to return power to the individual, enabling a life lived outside the reach of centralized oversight.">
            <svg class="w-full h-32 md:h-48 mb-4" viewBox="0 0 400 300" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M 160 220 L 200 50 L 240 220 L 200 180 Z" opacity="0.4" />
              <circle cx="200" cy="50" r="10" opacity="0.7" />
              <line x1="200" y1="20" x2="200" y2="40" opacity="0.8" />
              <path d="M 140 220 Q 200 200 260 220" opacity="0.5" />
            </svg>
            <h3 class="text-base md:text-lg mb-3" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 0.25em">SOVEREIGNTY</h3>
            <p class="text-xs" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 0.02em; line-height: 1.7; text-transform: none">Reclaiming the digital frontier. Tools for a self-governed and free existence.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- MobMap Section -->
    <section class="section" id="mobmap">
      <div class="section-content">
        <h1 class="text-4xl md:text-6xl font-bold mb-6 glow-text gothic-text text-center" style="font-weight: 100">MOBMAP</h1>
        <p class="text-xs md:text-sm mb-8 text-center max-w-3xl mx-auto" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 0.03em; line-height: 1.8; text-transform: none">there's levels to this game !</p>

        <div class="card max-w-4xl mx-auto" style="padding: 18px">
          <div id="mobmap-list" class="grid gap-px bg-white/5 border border-white/10" style="background-color: rgba(138, 43, 226, 0.05); border-color: rgba(138, 43, 226, 0.18)">
            <!-- Generated via JS -->
          </div>
        </div>

        <div class="relative w-full max-w-4xl mx-auto overflow-x-auto">
          <svg class="w-full h-64 md:h-96 min-w-[600px]" viewBox="0 0 800 400" fill="none" stroke="currentColor" stroke-width="1.5">
            <polygon points="400,160 440,200 400,240 360,200" stroke-width="2" opacity="0.9" />
            <polygon points="400,140 460,200 400,260 340,200" opacity="0.4" />
            <circle cx="400" cy="200" r="25" opacity="0.8" />
            <text x="400" y="205" text-anchor="middle" fill="currentColor" font-size="12" font-weight="bold" style="font-family: 'JetBrains Mono', monospace">HUB</text>

            <rect x="220" y="70" width="50" height="50" stroke="#0052FF" stroke-width="2" opacity="0.7" />
            <path d="M 220 70 Q 245 45 270 70" stroke="#0052FF" opacity="0.8" />
            <line x1="245" y1="70" x2="245" y2="50" stroke="#0052FF" opacity="0.9" />
            <text x="245" y="100" text-anchor="middle" fill="currentColor" font-size="11" style="font-family: 'JetBrains Mono', monospace">BASE</text>
            <path d="M 270 95 Q 335 150 370 180" stroke="#0052FF" opacity="0.4" />

            <rect x="530" y="70" width="50" height="50" stroke="#61DFFF" stroke-width="2" opacity="0.7" />
            <polygon points="530,70 555,40 580,70" stroke="#61DFFF" opacity="0.8" />
            <circle cx="555" cy="35" r="5" stroke="#61DFFF" opacity="0.9" />
            <text x="555" y="100" text-anchor="middle" fill="currentColor" font-size="11" style="font-family: 'JetBrains Mono', monospace">LINEA</text>
            <path d="M 530 95 Q 475 150 430 180" stroke="#61DFFF" opacity="0.4" />

            <rect x="640" y="220" width="50" height="50" stroke="#8247E5" stroke-width="2" opacity="0.7" />
            <polygon points="650,220 665,200 680,220" stroke="#8247E5" opacity="0.8" />
            <rect x="655" y="230" width="10" height="15" stroke="#8247E5" opacity="0.6" />
            <text x="665" y="250" text-anchor="middle" fill="currentColor" font-size="11" style="font-family: 'JetBrains Mono', monospace">POLYGON</text>
            <path d="M 640 220 Q 535 215 430 210" stroke="#8247E5" opacity="0.4" />

            <rect x="110" y="220" width="50" height="50" stroke="#00FFA3" stroke-width="2" opacity="0.7" />
            <rect x="135" y="195" width="10" height="25" stroke="#00FFA3" opacity="0.8" />
            <circle cx="140" cy="190" r="6" stroke="#00FFA3" opacity="0.9" />
            <text x="135" y="250" text-anchor="middle" fill="currentColor" font-size="11" style="font-family: 'JetBrains Mono', monospace">SOLANA</text>
            <path d="M 160 220 Q 265 215 370 210" stroke="#00FFA3" opacity="0.4" />

            <rect x="270" y="310" width="50" height="50" stroke="#8C8DFC" stroke-width="2" opacity="0.7" />
            <path d="M 270 310 Q 295 285 320 310" stroke="#8C8DFC" opacity="0.8" />
            <path d="M 285 310 Q 295 295 305 310" stroke="#8C8DFC" opacity="0.9" />
            <text x="295" y="340" text-anchor="middle" fill="currentColor" font-size="11" style="font-family: 'JetBrains Mono', monospace">ZKSYNC</text>
            <path d="M 320 310 Q 350 270 385 235" stroke="#8C8DFC" opacity="0.4" />

            <rect x="480" y="310" width="50" height="50" stroke="#8A2BE2" stroke-width="2" opacity="0.7" />
            <line x1="505" y1="285" x2="505" y2="310" stroke="#8A2BE2" opacity="0.8" stroke-width="3" />
            <line x1="492" y1="297" x2="518" y2="297" stroke="#8A2BE2" opacity="0.8" stroke-width="3" />
            <circle cx="505" cy="297" r="8" stroke="#8A2BE2" opacity="0.9" />
            <text x="505" y="340" text-anchor="middle" fill="currentColor" font-size="11" style="font-family: 'JetBrains Mono', monospace">MONAD</text>
            <path d="M 480 310 Q 450 270 415 235" stroke="#8A2BE2" opacity="0.4" />

            <circle cx="335" cy="190" r="4" opacity="0.6" />
            <circle cx="465" cy="190" r="4" opacity="0.6" />
            <circle cx="350" cy="265" r="4" opacity="0.6" />
            <circle cx="450" cy="265" r="4" opacity="0.6" />
          </svg>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-6 mt-8 md:mt-12 max-w-4xl mx-auto">
          <div class="card text-center">
            <h4 class="text-xs mb-2" style="font-family: 'JetBrains Mono', monospace; font-weight: 300; letter-spacing: 0.2em">6 NETWORKS</h4>
            <p class="text-lg md:text-xl glow-text" style="font-family: 'JetBrains Mono', monospace; font-weight: 700; letter-spacing: 0.15em">MULTI-CHAIN</p>
          </div>
          <div class="card text-center">
            <h4 class="text-xs mb-2" style="font-family: 'JetBrains Mono', monospace; font-weight: 300; letter-spacing: 0.2em">INTEROPERABILITY</h4>
            <p class="text-lg md:text-xl glow-text" style="font-family: 'JetBrains Mono', monospace; font-weight: 700; letter-spacing: 0.15em">SEAMLESS</p>
          </div>
          <div class="card text-center sm:col-span-2 md:col-span-1">
            <h4 class="text-xs mb-2" style="font-family: 'JetBrains Mono', monospace; font-weight: 300; letter-spacing: 0.2em">TRANSACTION SPEED</h4>
            <p class="text-lg md:text-xl glow-text" style="font-family: 'JetBrains Mono', monospace; font-weight: 700; letter-spacing: 0.15em">&lt;2S</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Team Section -->
    <section class="section" id="team">
      <div class="section-content">
        <h1 class="text-4xl md:text-6xl font-bold mb-6 glow-text gothic-text text-center" style="font-weight: 100">OUR TEAM</h1>
        <p class="text-xs md:text-sm mb-8 text-center max-w-3xl mx-auto" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 0.03em; line-height: 1.8; text-transform: none">The architects of the new world. Visionaries and builders shaping the future from the shadows.</p>
        <div class="grid-container">
          <div class="card text-center">
            <img src="https://unavatar.io/twitter/tokens617" alt="Profile avatar for tokens617" class="w-32 h-32 md:w-48 md:h-48 mx-auto mb-4 rounded-full object-cover border-4 border-current shadow-lg hover:scale-105 transition-transform duration-300 p-1" loading="lazy" width="192" height="192" style="outline: 1px solid currentColor; outline-offset: 5px" />
            <h3 class="text-xl md:text-2xl mb-2" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 2px">TOKENS</h3>
            <p class="text-xs md:text-sm opacity-70 mb-3" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; letter-spacing: 1px">@tokens617</p>
            <p class="text-xs" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 1px; text-transform: none">Onchain researcher. Cartographer of the dark forest. Building @METAMOB. ü¶áüîä</p>
          </div>
          <div class="card text-center">
            <img src="https://unavatar.io/twitter/dissimilis_tu" alt="Profile avatar for dissimilis_tu" class="w-32 h-32 md:w-48 md:h-48 mx-auto mb-4 rounded-full object-cover border-4 border-current shadow-lg hover:scale-105 transition-transform duration-300 p-1" loading="lazy" width="192" height="192" style="outline: 1px solid currentColor; outline-offset: 5px" />
            <h3 class="text-xl md:text-2xl mb-2" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 2px">DISSIMILIS</h3>
            <p class="text-xs md:text-sm opacity-70 mb-3" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; letter-spacing: 1px">@dissimilis_tu</p>
            <p class="text-xs" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 1px; text-transform: none">Building weird crypto things. Linguist. Solidity whisperer. Previously @Ethereum.</p>
          </div>
          <div class="card text-center">
            <img src="https://unavatar.io/twitter/futureLEGO" alt="Profile avatar for futureLEGO" class="w-32 h-32 md:w-48 md:h-48 mx-auto mb-4 rounded-full object-cover border-4 border-current shadow-lg hover:scale-105 transition-transform duration-300 p-1" loading="lazy" width="192" height="192" style="outline: 1px solid currentColor; outline-offset: 5px" />
            <h3 class="text-xl md:text-2xl mb-2" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 2px">FUTURE LEGO</h3>
            <p class="text-xs md:text-sm opacity-70 mb-3" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; letter-spacing: 1px">@futureLEGO</p>
            <p class="text-xs" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 1px; text-transform: none">Design @METAMOB. UX/UI. Pixel perfectionist. Cyberpunk enthusiast. üèóÔ∏è</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Shop Section -->
    <section class="section" id="mob-market">
      <div class="section-content">
        <h1 class="text-4xl md:text-6xl font-bold mb-6 glow-text gothic-text text-center" style="font-weight: 100">SHOP</h1>
        <p class="text-xs md:text-sm mb-8 text-center max-w-3xl mx-auto" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 1px; text-transform: none">The underground marketplace for digital assets, NFTs, and Web3 utilities. Trade in the shadows, collect in the light.</p>
        <div class="grid-container">
          <!-- Row 1 -->
          <div class="card">
            <svg class="w-full h-40 md:h-48 mb-4" viewBox="0 0 200 200" fill="none" stroke="currentColor" stroke-width="1.2">
              <!-- Flat front hoodie silhouette -->
              <!-- Simple hood -->
              <path d="M70,40 Q100,15 130,40 L130,80 L70,80 Z" opacity="0.7" />
              <!-- Hood opening -->
              <path d="M82,42 Q100,26 118,42 L118,72 L82,72 Z" opacity="0.6" />
              <!-- Drawstrings -->
              <line x1="96" y1="52" x2="96" y2="72" opacity="0.6" />
              <line x1="104" y1="52" x2="104" y2="72" opacity="0.6" />
              <!-- Body rectangle -->
              <rect x="60" y="80" width="80" height="90" opacity="0.5" />
              <!-- Sleeves -->
              <rect x="40" y="80" width="20" height="70" opacity="0.45" />
              <rect x="140" y="80" width="20" height="70" opacity="0.45" />
              <!-- Pocket -->
              <rect x="78" y="120" width="44" height="20" opacity="0.5" rx="3" ry="3" />
              <!-- Hem & cuffs lines -->
              <line x1="60" y1="170" x2="140" y2="170" opacity="0.5" />
              <line x1="40" y1="150" x2="60" y2="150" opacity="0.4" />
              <line x1="140" y1="150" x2="160" y2="150" opacity="0.4" />
            </svg>
            <h3 class="text-lg md:text-xl font-bold mb-1" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 2px">MOB HOODIE</h3>
            <p class="text-xs mb-4" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 1px; text-transform: none">Heavyweight wireframe textile. Stealth fit.</p>
            <button class="btn w-full">COMING SOON</button>
          </div>
          <div class="card">
            <svg class="w-full h-40 md:h-48 mb-4" viewBox="0 0 200 200" fill="none" stroke="currentColor" stroke-width="1.2">
              <!-- Flat front T-shirt -->
              <!-- Shoulder line -->
              <line x1="60" y1="50" x2="140" y2="50" opacity="0.7" />
              <!-- Neck opening -->
              <path d="M85,50 Q100,38 115,50" opacity="0.7" />
              <!-- Body rectangle -->
              <rect x="70" y="50" width="60" height="90" opacity="0.5" />
              <!-- Sleeves -->
              <rect x="50" y="50" width="20" height="45" opacity="0.45" />
              <rect x="130" y="50" width="20" height="45" opacity="0.45" />
              <!-- Hem line -->
              <line x1="70" y1="140" x2="130" y2="140" opacity="0.5" />
            </svg>
            <h3 class="text-lg md:text-xl font-bold mb-1" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 2px">MOB T-SHIRT</h3>
            <p class="text-xs mb-4" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 1px; text-transform: none">Organic cotton with encrypted print.</p>
            <button class="btn w-full">COMING SOON</button>
          </div>
          <div class="card">
            <svg class="w-full h-40 md:h-48 mb-4" viewBox="0 0 200 200" fill="none" stroke="currentColor" stroke-width="1.2">
              <!-- Flat baseball cap -->
              <!-- Simple crown -->
              <path d="M70,90 Q100,70 130,90 L130,110 L70,110 Z" opacity="0.7" />
              <!-- Crown center seam -->
              <line x1="100" y1="75" x2="100" y2="110" opacity="0.5" />
              <!-- Top button -->
              <circle cx="100" cy="72" r="2" opacity="0.7" />
              <!-- Curved visor -->
              <path d="M60,110 Q100,125 140,110 Q138,118 135,122 Q100,135 65,122 Q62,118 60,110 Z" opacity="0.7" />
            </svg>
            <h3 class="text-lg md:text-xl font-bold mb-1" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 2px">MOB CAP</h3>
            <p class="text-xs mb-4" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 1px; text-transform: none">Signal blocking fabric. Cyberpunk fit.</p>
            <button class="btn w-full">COMING SOON</button>
          </div>
          <!-- Row 2 -->
          <div class="card">
            <svg class="w-full h-40 md:h-48 mb-4" viewBox="0 0 200 200" fill="none" stroke="currentColor" stroke-width="1.2">
              <!-- Server rack frame -->
              <rect x="50" y="30" width="100" height="140" opacity="0.3" />
              <!-- Server unit 1 -->
              <rect x="55" y="40" width="90" height="20" opacity="0.4" />
              <circle cx="60" cy="50" r="2" opacity="0.7" />
              <circle cx="68" cy="50" r="2" opacity="0.7" />
              <line x1="80" y1="50" x2="140" y2="50" opacity="0.3" />
              <!-- Server unit 2 -->
              <rect x="55" y="65" width="90" height="20" opacity="0.4" />
              <circle cx="60" cy="75" r="2" opacity="0.7" />
              <circle cx="68" cy="75" r="2" opacity="0.7" />
              <line x1="80" y1="75" x2="140" y2="75" opacity="0.3" />
              <!-- Server unit 3 -->
              <rect x="55" y="90" width="90" height="20" opacity="0.4" />
              <circle cx="60" cy="100" r="2" opacity="0.7" />
              <circle cx="68" cy="100" r="2" opacity="0.7" />
              <line x1="80" y1="100" x2="140" y2="100" opacity="0.3" />
              <!-- Server unit 4 -->
              <rect x="55" y="115" width="90" height="20" opacity="0.4" />
              <circle cx="60" cy="125" r="2" opacity="0.7" />
              <circle cx="68" cy="125" r="2" opacity="0.7" />
              <line x1="80" y1="125" x2="140" y2="125" opacity="0.3" />
              <!-- Server unit 5 -->
              <rect x="55" y="140" width="90" height="20" opacity="0.4" />
              <circle cx="60" cy="150" r="2" opacity="0.7" />
              <circle cx="68" cy="150" r="2" opacity="0.7" />
              <line x1="80" y1="150" x2="140" y2="150" opacity="0.3" />
            </svg>
            <h3 class="text-lg md:text-xl font-bold mb-1" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 2px">VIRTUAL SERVER</h3>
            <p class="text-xs mb-4" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 1px; text-transform: none">High performance node in the cloud.</p>
            <button class="btn w-full">COMING SOON</button>
          </div>
          <div class="card">
            <svg class="w-full h-40 md:h-48 mb-4" viewBox="0 0 200 200" fill="none" stroke="currentColor" stroke-width="1.2">
              <!-- Outer ring -->
              <circle cx="100" cy="100" r="45" opacity="0.3" />
              <circle cx="100" cy="100" r="35" opacity="0.3" />
              <!-- Center device -->
              <circle cx="100" cy="100" r="12" opacity="0.7" />
              <!-- Antenna array -->
              <line x1="100" y1="45" x2="100" y2="65" opacity="0.5" />
              <line x1="100" y1="135" x2="100" y2="155" opacity="0.5" />
              <line x1="45" y1="100" x2="65" y2="100" opacity="0.5" />
              <line x1="135" y1="100" x2="155" y2="100" opacity="0.5" />
              <!-- Signal waves -->
              <path d="M115,85 Q125,100 115,115" opacity="0.4" />
              <path d="M125,75 Q140,100 125,125" opacity="0.3" />
              <!-- Directional arrows -->
              <path d="M85,55 L90,50 L95,55" opacity="0.6" />
              <path d="M105,145 L110,150 L115,145" opacity="0.6" />
            </svg>
            <h3 class="text-lg md:text-xl font-bold mb-1" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 2px">TRACKING DEVICE</h3>
            <p class="text-xs mb-4" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 1px; text-transform: none">GPS-free decentralized tracking.</p>
            <button class="btn w-full">COMING SOON</button>
          </div>
          <div class="card">
            <svg class="w-full h-40 md:h-48 mb-4" viewBox="0 0 200 200" fill="none" stroke="currentColor" stroke-width="1.2">
              <!-- Hexagonal frame -->
              <polygon points="100,30 170,70 170,130 100,170 30,130 30,70" opacity="0.4" />
              <!-- Inner hexagon -->
              <polygon points="100,50 150,80 150,120 100,150 50,120 50,80" opacity="0.3" />
              <!-- Center orb -->
              <circle cx="100" cy="100" r="20" opacity="0.7" />
              <!-- Data nodes -->
              <circle cx="100" cy="60" r="3" opacity="0.6" />
              <circle cx="150" cy="90" r="3" opacity="0.6" />
              <circle cx="150" cy="110" r="3" opacity="0.6" />
              <circle cx="100" cy="140" r="3" opacity="0.6" />
              <circle cx="50" cy="110" r="3" opacity="0.6" />
              <circle cx="50" cy="90" r="3" opacity="0.6" />
              <!-- Connection lines -->
              <line x1="100" y1="60" x2="100" y2="80" opacity="0.3" />
              <line x1="150" y1="90" x2="120" y2="100" opacity="0.3" />
              <line x1="150" y1="110" x2="120" y2="100" opacity="0.3" />
              <line x1="100" y1="140" x2="100" y2="120" opacity="0.3" />
              <line x1="50" y1="110" x2="80" y2="100" opacity="0.3" />
              <line x1="50" y1="90" x2="80" y2="100" opacity="0.3" />
            </svg>
            <h3 class="text-lg md:text-xl font-bold mb-1" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 2px">MOB NFT</h3>
            <p class="text-xs mb-4" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 1px; text-transform: none">Unique identity for the metaverse.</p>
            <button class="btn w-full">COMING SOON</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Events Section -->
    <section class="section" id="events">
      <div class="section-content">
        <h1 class="text-4xl md:text-6xl font-bold mb-6 glow-text gothic-text text-center" style="font-weight: 100">EVENTS</h1>
        <p class="text-xs md:text-sm mb-8 text-center max-w-3xl mx-auto" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 1px; text-transform: none">7-day operational schedule. Syncing with the METAMOB encrypted collective.</p>

        <div class="card" style="padding: 18px">
          <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3 mb-4">
            <div class="flex items-center gap-3">
              <div class="text-xs opacity-70" style="text-transform: none">Timezone:</div>
              <select id="tzSelect" class="bg-transparent border border-current px-3 py-2 text-xs" style="outline: none">
                <option value="local">Local</option>
                <option value="utc">UTC</option>
              </select>
              <div class="text-xs opacity-70" style="text-transform: none">Jump:</div>
              <button class="btn" id="eventsTodayBtn">Today</button>
            </div>
          </div>

          <div class="events-calendar" role="region" aria-label="Events calendar">
            <div class="events-head" id="eventsHead" aria-hidden="false"></div>
            <div class="events-grid" id="eventsGrid">
              <div class="events-time-col" id="eventsTimeCol" aria-hidden="true"></div>
              <div class="events-days" id="eventsDays"></div>
            </div>
          </div>

          <div class="mt-4 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
            <div class="text-xs" id="eventsHint" style="text-transform: none; opacity: 0.9"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- News Section -->
    <section class="section" id="news">
      <div class="section-content">
        <h1 class="text-4xl md:text-6xl font-bold mb-6 glow-text gothic-text text-center" style="font-weight: 100">LATEST NEWS</h1>
        <p class="text-xs md:text-sm mb-8 text-center max-w-3xl mx-auto" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 1px; text-transform: none">Stay informed with the latest developments from the underground. Partnerships, milestones, and revolutions in progress.</p>
        <div class="space-y-4 md:space-y-6" id="newsContainer">
          <div class="card flex flex-col md:flex-row gap-4 md:gap-6">
            <img src="https://picsum.photos/500?random=1" alt="Multi-chain integration news thumbnail" class="w-full md:w-48 lg:w-64 h-32 md:h-48 flex-shrink-0 object-cover rounded-lg border-2 border-current shadow-lg" loading="lazy" width="500" height="400" />
            <div class="flex-1">
              <div class="text-xs opacity-70 mb-2" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; letter-spacing: 1px">DECEMBER 15, 2024</div>
              <h3 class="text-xl md:text-2xl lg:text-3xl font-bold mb-3 glow-text" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 2px">MULTI-CHAIN COMPLETE</h3>
              <p class="text-xs md:text-sm mb-4" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 1px; text-transform: none">We've successfully integrated with all six major blockchain networks. The underground is now connected.</p>
              <button class="btn">READ MORE ‚Üí</button>
            </div>
          </div>
          <div class="card flex flex-col md:flex-row gap-4 md:gap-6">
            <img src="https://picsum.photos/500?random=2" alt="Record trading volume news thumbnail" class="w-full md:w-48 lg:w-64 h-32 md:h-48 flex-shrink-0 object-cover rounded-lg border-2 border-current shadow-lg" loading="lazy" width="500" height="400" />
            <div class="flex-1">
              <div class="text-xs opacity-70 mb-2" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; letter-spacing: 1px">DECEMBER 10, 2024</div>
              <h3 class="text-xl md:text-2xl lg:text-3xl font-bold mb-3 glow-text" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 2px">RECORD VOLUME</h3>
              <p class="text-xs md:text-sm mb-4" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 1px; text-transform: none">The market reached an all-time high with over $10M in trading volume. The revolution grows stronger.</p>
              <button class="btn">READ MORE ‚Üí</button>
            </div>
          </div>
          <div class="card flex flex-col md:flex-row gap-4 md:gap-6">
            <img src="https://picsum.photos/500?random=3" alt="Strategic partnerships news thumbnail" class="w-full md:w-48 lg:w-64 h-32 md:h-48 flex-shrink-0 object-cover rounded-lg border-2 border-current shadow-lg" loading="lazy" width="500" height="400" />
            <div class="flex-1">
              <div class="text-xs opacity-70 mb-2" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; letter-spacing: 1px">DECEMBER 5, 2024</div>
              <h3 class="text-xl md:text-2xl lg:text-3xl font-bold mb-3 glow-text" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 2px">NEW ALLIANCES</h3>
              <p class="text-xs md:text-sm mb-4" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 1px; text-transform: none">Strategic partnerships announced with leading Web3 protocols. Together we build the future.</p>
              <button class="btn">READ MORE ‚Üí</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Partners Section -->
    <section class="section" id="partners">
      <div class="section-content">
        <h1 class="text-4xl md:text-6xl font-bold mb-6 glow-text gothic-text text-center" style="font-weight: 100">OUR PARTNERS</h1>
        <p class="text-xs md:text-sm mb-8 text-center max-w-3xl mx-auto" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 0.03em; line-height: 1.8; text-transform: none">Networks and protocols that anchor METAMOB in the onchain dark city.</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 justify-items-center">
          <!-- 9 partner frames, each 200x50 with logo + label -->
          <div class="flex items-center gap-3 border border-current px-3" style="width: 200px; height: 50px">
            <img src="https://avatars.githubusercontent.com/u/108554348?s=280&v=4" alt="Base logo" class="w-8 h-8 object-contain" loading="lazy" />
            <span class="text-xs tracking-[0.2em]">BASE</span>
          </div>
          <div class="flex items-center gap-3 border border-current px-3" style="width: 200px; height: 50px">
            <img src="https://coinfactory.app/images/networks/linea.svg" alt="Linea logo" class="w-8 h-8 object-contain" loading="lazy" />
            <span class="text-xs tracking-[0.2em]">LINEA</span>
          </div>
          <div class="flex items-center gap-3 border border-current px-3" style="width: 200px; height: 50px">
            <img src="https://docs.monad.xyz/img/monad_logo.png" alt="Monad logo" class="w-8 h-8 object-contain" loading="lazy" />
            <span class="text-xs tracking-[0.2em]">MONAD</span>
          </div>
          <div class="flex items-center gap-3 border border-current px-3" style="width: 200px; height: 50px">
            <img src="https://cryptologos.cc/logos/polygon-matic-logo.png?v=026" alt="Polygon logo" class="w-8 h-8 object-contain" loading="lazy" />
            <span class="text-xs tracking-[0.2em]">POLYGON</span>
          </div>
          <div class="flex items-center gap-3 border border-current px-3" style="width: 200px; height: 50px">
            <img src="https://cryptologos.cc/logos/solana-sol-logo.png?v=026" alt="Solana logo" class="w-8 h-8 object-contain" loading="lazy" />
            <span class="text-xs tracking-[0.2em]">SOLANA</span>
          </div>
          <div class="flex items-center gap-3 border border-current px-3" style="width: 200px; height: 50px">
            <img src="https://icodrops.com/media/projects/logos/zksync_logo_1740179262.webp" alt="zkSync logo" class="w-8 h-8 object-contain" loading="lazy" />
            <span class="text-xs tracking-[0.2em]">ZKSYNC</span>
          </div>
          <div class="flex items-center gap-3 border border-current px-3" style="width: 200px; height: 50px">
            <img src="https://cryptologos.cc/logos/chainlink-link-logo.png?v=026" alt="Chainlink logo" class="w-8 h-8 object-contain" loading="lazy" />
            <span class="text-xs tracking-[0.2em]">CHAINLINK</span>
          </div>
          <div class="flex items-center gap-3 border border-current px-3" style="width: 200px; height: 50px">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9f/IPFS_logo.svg/1028px-IPFS_logo.svg.png" alt="IPFS logo" class="w-8 h-8 object-contain" loading="lazy" />
            <span class="text-xs tracking-[0.2em]">IPFS</span>
          </div>
          <div class="flex items-center gap-3 border border-current px-3" style="width: 200px; height: 50px">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/MetaMask_Fox.svg/512px-MetaMask_Fox.svg.png" alt="MetaMask logo" class="w-8 h-8 object-contain" loading="lazy" />
            <span class="text-xs tracking-[0.2em]">METAMASK</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="site-footer" id="siteFooter" role="contentinfo">
      <div class="site-footer-inner">
        <div class="footer-copy" id="footerCopy">¬© <span id="footerYear"></span> METAMOB. ALL RIGHTS RESERVED.</div>
        <div id="socials" class="social" aria-label="Social links">
          <a href="https://t.me/metamob3" id="tme" target="_blank" rel="noopener noreferrer"><img src="https://ipfs.io/ipfs/bafybeicks42jnz3dctcijwg7aan2dlgmm7pije6j2daywn5ze37pnp6ini/tme.webp" class="icon" alt="Telegram" loading="lazy" /></a>
          <a href="https://x.com/tokens617" id="xcom" target="_blank" rel="noopener noreferrer"><img src="https://ipfs.io/ipfs/bafybeicks42jnz3dctcijwg7aan2dlgmm7pije6j2daywn5ze37pnp6ini/xcom.webp" class="icon" alt="X.com" loading="lazy" /></a>
          <a href="https://www.instagram.com/meta_mob_" id="insta" target="_blank" rel="noopener noreferrer"><img src="https://ipfs.io/ipfs/bafybeicks42jnz3dctcijwg7aan2dlgmm7pije6j2daywn5ze37pnp6ini/insta.png" class="icon" alt="Instagram" loading="lazy" /></a>
          <a href="https://www.tiktok.com/@meta.mob6" id="tiktok" target="_blank" rel="noopener noreferrer"><img src="https://ipfs.io/ipfs/bafybeicks42jnz3dctcijwg7aan2dlgmm7pije6j2daywn5ze37pnp6ini/tiktok.png" class="icon" alt="TikTok" loading="lazy" /></a>
        </div>
        <div class="footer-links" aria-label="Legal links">
          <button class="footer-link" id="privacyLink" type="button">PRIVACY</button>
          <button class="footer-link" id="termsLink" type="button">TERMS OF SERVICE</button>
        </div>
      </div>
    </footer>

    <!-- Ethos Details Modal -->
    <div class="legal-modal-overlay" id="ethosModalOverlay" aria-hidden="true">
      <div class="legal-modal" id="ethosModal" role="dialog" aria-modal="true" aria-labelledby="ethosModalTitle">
        <div class="legal-modal-header">
          <h3 class="legal-modal-title" id="ethosModalTitle">ETHOS DETAIL</h3>
          <button class="legal-modal-close" id="ethosModalClose" aria-label="Close">&times;</button>
        </div>
        <div class="legal-modal-body ethos-modal-body">
          <img id="ethosModalImage" src="" alt="Ethos visual" class="ethos-modal-image" />
          <div id="ethosModalText" class="ethos-modal-text"></div>
        </div>
      </div>
    </div>

    <!-- Wallet Action Modal -->
    <div class="legal-modal-overlay" id="walletActionOverlay" aria-hidden="true">
      <div class="legal-modal" id="walletActionModal" role="dialog" aria-modal="true" aria-labelledby="walletActionTitle">
        <div class="legal-modal-header">
          <h3 class="legal-modal-title" id="walletActionTitle">WALLET ACTION</h3>
          <button class="legal-modal-close" id="walletActionClose" aria-label="Close">&times;</button>
        </div>
        <div class="wallet-modal-body" id="walletActionBody"></div>
      </div>
    </div>

    <!-- Legal Modals -->
    <div class="legal-modal-overlay" id="legalModalOverlay" aria-hidden="true">
      <div class="legal-modal" id="legalModal" role="dialog" aria-modal="true" aria-labelledby="legalModalTitle">
        <div class="legal-modal-header">
          <h3 class="legal-modal-title" id="legalModalTitle">LEGAL</h3>
          <button class="legal-modal-close" id="legalModalClose" aria-label="Close">&times;</button>
        </div>
        <div class="legal-modal-body" id="legalModalBody"></div>
      </div>
    </div>

    <!-- Product Variants Modal -->
    <div class="product-overlay" id="productVariantsOverlay" aria-hidden="true">
      <div class="product-modal" id="productVariantsModal" role="dialog" aria-modal="true" aria-labelledby="productVariantsTitle">
        <div class="product-modal-header">
          <div>
            <div class="product-modal-title" id="productVariantsTitle">PRODUCT VARIANTS</div>
            <div class="detail-sub" id="productVariantsSubtitle" style="text-transform: none; margin-top: 4px">Select a variant to view details or purchase.</div>
          </div>
          <button class="product-modal-close" id="productVariantsClose" aria-label="Close">&times;</button>
        </div>
        <div class="product-modal-body">
          <div class="variant-grid" id="variantGrid"></div>
        </div>
      </div>
    </div>

    <!-- Product Detail Overlay ("page") -->
    <div class="product-overlay" id="productDetailOverlay" aria-hidden="true">
      <div class="product-detail" id="productDetail" role="dialog" aria-modal="true" aria-labelledby="productDetailTitle">
        <div class="product-detail-header">
          <div>
            <div class="product-modal-title" id="productDetailKicker">PRODUCT</div>
            <div class="detail-title" id="productDetailTitle">ITEM</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn" type="button" id="productDetailBackBtn">BACK</button>
            <button class="product-modal-close" id="productDetailClose" aria-label="Close">&times;</button>
          </div>
        </div>
        <div class="product-detail-body">
          <div class="grid gap-3">
            <img class="detail-img" id="productDetailImage" src="https://picsum.photos/800?random=100" alt="Product image" loading="lazy" />
            <div class="detail-text" id="productDetailStory"></div>
          </div>
          <div class="grid gap-4">
            <div class="card" style="padding: 16px">
              <div class="grid gap-2">
                <div class="detail-sub" id="productDetailCategory"></div>
                <div class="price-tag" id="productDetailPrice"></div>
                <div class="detail-text" id="productDetailDescription"></div>
                <ul class="spec-list" id="productDetailSpecs"></ul>
                <div class="variant-actions" style="margin-top: 6px">
                  <button class="btn w-full" type="button" id="productDetailBuyBtn">BUY NOW</button>
                </div>
                <div class="detail-sub" id="productDetailFootnote" style="text-transform: none"></div>
              </div>
            </div>
            <div class="card" style="padding: 16px">
              <div class="detail-sub" style="margin-bottom: 8px">ONCHAIN STATUS</div>
              <div class="detail-text" style="text-transform: none">This is a UI prototype. Purchase actions are simulated. Hook into your checkout / contract calls when ready.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <script>
      // ============================================
      // MOBILE DETECTION & PERFORMANCE SETTINGS
      // ============================================
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
      const isLowPerfDevice = isMobile || navigator.hardwareConcurrency < 4;

      // ============================================
      // COLOR PALETTES
      // ============================================
      const palettes = [
        {background: '#0a0a0f', accent: '#8A2BE2', text: '#e0e0e0', name: 'Dark Void', fog: '#0a0a0f'},
        {background: '#0d1117', accent: '#00FF00', text: '#00FF00', name: 'Matrix', fog: '#0d1117'},
        {background: '#ffffff', accent: '#0088FF', text: '#1a0a1a', name: 'Light Gothic', fog: '#ffffff'},
      ];

      let currentPalette = 0;

      // ============================================
      // APPLY COLOR PALETTE
      // ============================================
      function applyPalette(index) {
        const palette = palettes[index];
        document.body.style.backgroundColor = palette.background;
        document.body.style.color = palette.text;

        document.querySelector('.navbar').style.backgroundColor = palette.background + 'CC';
        document.querySelector('.navbar').style.borderColor = palette.accent + '40';

        document.querySelectorAll('.nav-link, .mobile-nav-link').forEach((link) => {
          link.style.color = palette.text;
        });

        document.querySelectorAll('.section').forEach((section) => {
          section.style.backgroundColor = palette.background + '15';
        });

        document.querySelectorAll('.btn').forEach((btn) => {
          btn.style.backgroundColor = 'transparent';
          btn.style.color = palette.text;
          btn.style.borderColor = palette.accent;
        });

        document.querySelectorAll('.card').forEach((card) => {
          card.style.backgroundColor = palette.background + '25';
          card.style.borderColor = palette.accent + '40';
        });

        // Events calendar borders use accent for crisp contrast
        document.querySelectorAll('.events-head, .events-grid').forEach((el) => {
          if (el) el.style.borderColor = palette.accent + '40';
        });
        document.querySelectorAll('.events-time-col, .events-day').forEach((el) => {
          if (el) el.style.borderColor = palette.accent + '35';
        });

        document.querySelectorAll('.dropdown-content').forEach((dropdown) => {
          dropdown.style.backgroundColor = palette.background + 'EE';
          dropdown.style.borderColor = palette.accent + '40';
        });

        document.querySelectorAll('.hamburger span').forEach((span) => {
          span.style.backgroundColor = palette.text;
        });

        // Mobile menu overlay
        document.getElementById('mobileMenuOverlay').style.backgroundColor = palette.background + 'F5';

        // Footer styling
        const footer = document.getElementById('siteFooter');
        if (footer) {
          footer.style.backgroundColor = palette.background + 'CC';
          footer.style.borderTopColor = palette.accent + '55';
          footer.style.color = palette.text;
        }

        // Event modal
        const modal = document.getElementById('eventModal');
        if (modal) {
          modal.style.setProperty('--bg-color', palette.background);
          modal.style.background = palette.background;
          modal.style.borderColor = palette.accent + '50';
        }

        // Legal modal
        const legalModal = document.getElementById('legalModal');
        if (legalModal) {
          legalModal.style.setProperty('--bg-color', palette.background);
          legalModal.style.background = palette.background;
          legalModal.style.borderColor = palette.accent + '55';
        }

        const walletModal = document.getElementById('walletActionModal');
        if (walletModal) {
          walletModal.style.setProperty('--bg-color', palette.background);
          walletModal.style.background = palette.background;
          walletModal.style.borderColor = palette.accent + '55';
        }

        // Product modals / detail overlays
        if (typeof applyProductModalTheme === 'function') {
          applyProductModalTheme(palette);
        }

        // META MOB MANTRAS COLORS
        const mantrasTitle = document.getElementById('metaMobMantrasTitle');
        const mantrasQuote = document.getElementById('metaMobMantrasQuote');
        if (mantrasTitle) {
          // Always cyan like the dodecahedron mesh
          mantrasTitle.style.color = '#00FFFF';
        }
        if (mantrasQuote) {
          // Uses accent color (same as hexagonal ring)
          mantrasQuote.style.color = palette.accent;
        }

        updateThreeJSColors(palette);
      }

      // ============================================
      // SYNC COLOR SLIDERS
      // ============================================
      function syncSliders(value) {
        document.getElementById('colorSlider').value = value;
        document.getElementById('mobileColorSlider').value = value;
        currentPalette = parseInt(value);
        applyPalette(currentPalette);
      }

      document.getElementById('colorSlider').addEventListener('input', (e) => syncSliders(e.target.value));
      document.getElementById('mobileColorSlider').addEventListener('input', (e) => syncSliders(e.target.value));

      // ============================================
      // MOBILE MENU
      // ============================================
      const hamburger = document.getElementById('hamburger');
      const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');

      function toggleMobileMenu() {
        hamburger.classList.toggle('active');
        mobileMenuOverlay.classList.toggle('active');
        document.body.classList.toggle('menu-open');
      }

      function closeMobileMenu() {
        hamburger.classList.remove('active');
        mobileMenuOverlay.classList.remove('active');
        document.body.classList.remove('menu-open');
      }

      hamburger.addEventListener('click', toggleMobileMenu);

      // Mobile navigation links
      document.querySelectorAll('.mobile-nav-link').forEach((link) => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const section = document.getElementById(link.dataset.section);
          closeMobileMenu();
          setTimeout(() => {
            section.scrollIntoView({behavior: 'smooth'});
          }, 300);
          document.querySelectorAll('.mobile-nav-link').forEach((l) => l.classList.remove('active'));
          link.classList.add('active');
        });
      });

      // Desktop navigation links
      document.querySelectorAll('.nav-link').forEach((link) => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const section = document.getElementById(link.dataset.section);
          if (section) section.scrollIntoView({behavior: 'smooth'});
          document.querySelectorAll('.nav-link').forEach((l) => l.classList.remove('active'));
          link.classList.add('active');
        });
      });

      // ============================================
      // DROPDOWNS
      // ============================================
      document.getElementById('networkBtn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('networkDropdown').classList.toggle('show');
        document.getElementById('walletDropdown').classList.remove('show');
      });

      document.getElementById('connectBtn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('walletDropdown').classList.toggle('show');
        document.getElementById('networkDropdown').classList.remove('show');
      });

      window.addEventListener('click', () => {
        document.querySelectorAll('.dropdown-content').forEach((d) => d.classList.remove('show'));
      });

      // Network Selection
      document.querySelectorAll('#networkDropdown .dropdown-item').forEach((item) => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          const network = item.dataset.network;
          document.getElementById('currentNetwork').textContent = network;
          document.getElementById('mobileCurrentNetwork').textContent = network;
          document.getElementById('networkDropdown').classList.remove('show');
        });
      });

      // ============================================
      // WEB3 WALLET CONNECTION
      // ============================================
      let userAddress = null;
      let currentChainId = null;
      const walletState = {
        isConnected: false,
        address: null,
        chainId: null,
      };

      // Check if MetaMask is installed
      async function checkWalletAvailability() {
        if (typeof window.ethereum !== 'undefined') {
          return true;
        }
        return false;
      }

      // Connect to MetaMask
      async function connectWallet() {
        try {
          const hasWallet = await checkWalletAvailability();
          if (!hasWallet) {
            alert('Please install MetaMask to connect your wallet');
            return null;
          }

          // Request account access
          const accounts = await window.ethereum.request({
            method: 'eth_requestAccounts',
          });

          if (accounts.length === 0) {
            return null;
          }

          const address = accounts[0];
          const chainId = await window.ethereum.request({
            method: 'eth_chainId',
          });

          // Update state
          walletState.isConnected = true;
          walletState.address = address;
          walletState.chainId = parseInt(chainId, 16);

          // Save to localStorage
          localStorage.setItem('metamob_connected', 'true');
          localStorage.setItem('metamob_address', address);
          localStorage.setItem('metamob_chainId', chainId);

          // Update UI
          updateWalletUI(address);

          console.log('Wallet connected:', address);
          return address;
        } catch (error) {
          console.error('Wallet connection error:', error);
          if (error.code === 4001) {
            console.log('User rejected connection');
          }
          return null;
        }
      }

      // Switch network
      async function switchNetwork(networkName) {
        const networks = {
          Base: {
            chainId: '0x2105',
            chainName: 'Base',
            nativeCurrency: {name: 'ETH', symbol: 'ETH', decimals: 18},
            rpcUrls: ['https://mainnet.base.org'],
            blockExplorerUrls: ['https://basescan.org'],
            apiEndpoint: 'https://api.basescan.org/api',
          },
          Linea: {
            chainId: '0xe708',
            chainName: 'Linea Mainnet',
            nativeCurrency: {name: 'ETH', symbol: 'ETH', decimals: 18},
            rpcUrls: ['https://rpc.linea.build'],
            blockExplorerUrls: ['https://lineascan.build'],
            apiEndpoint: 'https://api.lineascan.build/api',
          },
          Monad: {
            chainId: '0x14a34',
            chainName: 'Monad Testnet',
            nativeCurrency: {name: 'MON', symbol: 'MON', decimals: 18},
            rpcUrls: ['https://testnet-rpc.monad.xyz'],
            blockExplorerUrls: ['https://testnet-explorer.monad.xyz'],
            apiEndpoint: 'https://testnet-explorer.monad.xyz/api', // Unverified, placeholder
          },
          Polygon: {
            chainId: '0x89',
            chainName: 'Polygon Mainnet',
            nativeCurrency: {name: 'MATIC', symbol: 'MATIC', decimals: 18},
            rpcUrls: ['https://polygon-rpc.com'],
            blockExplorerUrls: ['https://polygonscan.com'],
            apiEndpoint: 'https://api.polygonscan.com/api',
          },
          Solana: {
            chainId: '0x91',
            chainName: 'Solana',
            nativeCurrency: {name: 'SOL', symbol: 'SOL', decimals: 9},
            rpcUrls: ['https://api.mainnet-beta.solana.com'],
            blockExplorerUrls: ['https://explorer.solana.com'],
            apiEndpoint: null, // Etherscan API not applicable for Solana
          },
          zkSync: {
            chainId: '0x144',
            chainName: 'zkSync Era',
            nativeCurrency: {name: 'ETH', symbol: 'ETH', decimals: 18},
            rpcUrls: ['https://mainnet.era.zksync.io'],
            blockExplorerUrls: ['https://era.zksync.network'],
            apiEndpoint: 'https://api-era.zksync.network/api', // Unverified, placeholder
          },
        };

        const network = networks[networkName];
        if (!network) {
          console.error('Unknown network:', networkName);
          return false;
        }

        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{chainId: network.chainId}],
          });
          console.log('Switched to network:', networkName);
          return true;
        } catch (switchError) {
          // This error code indicates that the chain has not been added to MetaMask
          if (switchError.code === 4902) {
            try {
              await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [network],
              });
              console.log('Added and switched to network:', networkName);
              return true;
            } catch (addError) {
              console.error('Failed to add network:', addError);
              return false;
            }
          }
          console.error('Failed to switch network:', switchError);
          return false;
        }
      }

      // Disconnect wallet
      function disconnectWallet() {
        walletState.isConnected = false;
        walletState.address = null;
        walletState.chainId = null;

        localStorage.removeItem('metamob_connected');
        localStorage.removeItem('metamob_address');
        localStorage.removeItem('metamob_chainId');

        // Reset UI
        const connectBtn = document.getElementById('connectBtn');
        connectBtn.style.display = 'inline-block';
        connectBtn.textContent = 'Connect Wallet';

        document.getElementById('walletDropdownContainer').style.display = 'none';

        const mobileConnectBtn = document.getElementById('mobileConnectBtn');
        mobileConnectBtn.style.display = 'inline-block';
        mobileConnectBtn.textContent = 'Connect';

        document.getElementById('mobileWalletConnected').style.display = 'none';

        console.log('Wallet disconnected');
      }

      // Format address for display
      function formatAddress(address) {
        if (!address) return '0x0000...0000';
        return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
      }

      // Update wallet UI
      function updateWalletUI(address) {
        const shortAddress = formatAddress(address);

        // Desktop
        document.getElementById('connectBtn').textContent = 'Connect Wallet';
        document.getElementById('connectBtn').style.display = 'none';
        document.getElementById('walletDropdownContainer').style.display = 'block';
        document.getElementById('walletAddressShort').textContent = shortAddress;

        // Mobile
        document.getElementById('mobileConnectBtn').textContent = 'Connect';
        document.getElementById('mobileConnectBtn').style.display = 'none';
        document.getElementById('mobileWalletConnected').style.display = 'block';
        document.getElementById('mobileWalletAddressShort').textContent = shortAddress;
      }

      // Auto-reconnect on page load
      async function autoReconnect() {
        const wasConnected = localStorage.getItem('metamob_connected') === 'true';
        const savedAddress = localStorage.getItem('metamob_address');

        if (wasConnected && savedAddress) {
          const hasWallet = await checkWalletAvailability();
          if (hasWallet) {
            try {
              const accounts = await window.ethereum.request({
                method: 'eth_accounts',
              });

              if (accounts.length > 0 && accounts[0].toLowerCase() === savedAddress.toLowerCase()) {
                const chainId = await window.ethereum.request({
                  method: 'eth_chainId',
                });

                walletState.isConnected = true;
                walletState.address = accounts[0];
                walletState.chainId = parseInt(chainId, 16);

                updateWalletUI(accounts[0]);
                console.log('Auto-reconnected:', accounts[0]);
              }
            } catch (error) {
              console.error('Auto-reconnect failed:', error);
            }
          }
        }
      }

      // Connect button click handler
      document.getElementById('connectBtn').addEventListener('click', connectWallet);
      document.getElementById('mobileConnectBtn').addEventListener('click', connectWallet);

      // Network selection
      document.querySelectorAll('#networkDropdown .dropdown-item').forEach((item) => {
        item.addEventListener('click', async (e) => {
          e.stopPropagation();
          const network = item.dataset.network;
          const success = await switchNetwork(network);
          if (success) {
            document.getElementById('currentNetwork').textContent = network;
            document.getElementById('mobileCurrentNetwork').textContent = network;
          }
          document.getElementById('networkDropdown').classList.remove('show');
        });
      });

      // Wallet menu dropdown
      document.getElementById('walletMenuBtn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('walletDropdown').classList.toggle('show');
        document.getElementById('networkDropdown').classList.remove('show');
      });

      // Wallet actions
      document.querySelectorAll('#walletDropdown .dropdown-item').forEach((item) => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          const action = item.dataset.action;
          if (action === 'logout') {
            disconnectWallet();
          } else {
            handleWalletAction(action);
          }
          document.getElementById('walletDropdown').classList.remove('show');
        });
      });

      // MetaMask event listeners
      if (typeof window.ethereum !== 'undefined') {
        window.ethereum.on('accountsChanged', (accounts) => {
          console.log('Accounts changed:', accounts);
          if (accounts.length === 0) {
            disconnectWallet();
          } else {
            walletState.address = accounts[0];
            walletState.isConnected = true;
            localStorage.setItem('metamob_address', accounts[0]);
            updateWalletUI(accounts[0]);
          }
        });

        window.ethereum.on('chainChanged', (chainId) => {
          console.log('Chain changed:', chainId);
          walletState.chainId = parseInt(chainId, 16);
          localStorage.setItem('metamob_chainId', chainId);
          // Reload page to clear any cached state
          window.location.reload();
        });

        window.ethereum.on('disconnect', () => {
          console.log('Wallet disconnected');
          disconnectWallet();
        });

        // Auto-reconnect on load
        autoReconnect();
      }

      // ============================================
      // INTERSECTION OBSERVER
      // ============================================
      const observerOptions = {threshold: 0.2};
      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const content = entry.target.querySelector('.section-content');
            if (content) content.classList.add('visible');
            const sectionId = entry.target.id;
            document.querySelectorAll('.nav-link, .mobile-nav-link').forEach((link) => {
              link.classList.remove('active');
              if (link.dataset.section === sectionId) link.classList.add('active');
            });
          }
        });
      }, observerOptions);

      document.querySelectorAll('.section').forEach((section) => observer.observe(section));

      // ============================================
      // EVENTS CALENDAR (7 DAYS / 24H / 1H)
      // ============================================
      const ROW_H = 20; // px per hour
      const SLOT_MIN = 60;
      const SLOTS_PER_DAY = 24;

      const tzSelect = document.getElementById('tzSelect');
      const eventsTodayBtn = document.getElementById('eventsTodayBtn');
      const eventsHead = document.getElementById('eventsHead');
      const eventsTimeCol = document.getElementById('eventsTimeCol');
      const eventsDays = document.getElementById('eventsDays');
      const eventsHint = document.getElementById('eventsHint');
      const eventModalOverlay = document.getElementById('eventModalOverlay');
      const eventModal = document.getElementById('eventModal');
      const modalClose = document.getElementById('modalClose');

      function pad2(n) {
        return String(n).padStart(2, '0');
      }

      function startOfDay(d, useUTC) {
        const x = new Date(d);
        if (useUTC) x.setUTCHours(0, 0, 0, 0);
        else x.setHours(0, 0, 0, 0);
        return x;
      }

      function dayKey(d, useUTC) {
        if (useUTC) return `${d.getUTCFullYear()}-${d.getUTCMonth()}-${d.getUTCDate()}`;
        return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
      }

      // Week view starts on Monday (ISO-style) so MON is always visible
      function startOfWeekMonday(d, useUTC) {
        const x = startOfDay(d, useUTC);
        const dow = useUTC ? x.getUTCDay() : x.getDay(); // 0=Sun..6=Sat
        const daysSinceMonday = (dow + 6) % 7; // Mon->0, Tue->1, ... Sun->6
        if (useUTC) x.setUTCDate(x.getUTCDate() - daysSinceMonday);
        else x.setDate(x.getDate() - daysSinceMonday);
        return x;
      }

      function fmtDayLabel(d, useUTC) {
        const weekdays = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];

        if (useUTC) {
          const weekday = weekdays[d.getUTCDay()];
          const month = months[d.getUTCMonth()];
          const day = String(d.getUTCDate()).padStart(2, '0');
          return {weekday, date: `${month} ${day}`};
        } else {
          const weekday = weekdays[d.getDay()];
          const month = months[d.getMonth()];
          const day = String(d.getDate()).padStart(2, '0');
          return {weekday, date: `${month} ${day}`};
        }
      }

      function minutesSinceStartOfDay(date, useUTC) {
        return useUTC ? date.getUTCHours() * 60 + date.getUTCMinutes() : date.getHours() * 60 + date.getMinutes();
      }

      function setTimeOnDay(dayStart, minutes, useUTC) {
        const d = new Date(dayStart);
        const h = Math.floor(minutes / 60);
        const m = minutes % 60;
        if (useUTC) {
          d.setUTCHours(h, m, 0, 0);
        } else {
          d.setHours(h, m, 0, 0);
        }
        return d;
      }

      function fmtTimeHM(date, useUTC) {
        const h = useUTC ? date.getUTCHours() : date.getHours();
        const m = useUTC ? date.getUTCMinutes() : date.getMinutes();
        return `${pad2(h)}:${pad2(m)}`;
      }

      function buildTimeCol() {
        if (!eventsTimeCol) return;
        eventsTimeCol.innerHTML = '';
        for (let slot = 0; slot < SLOTS_PER_DAY; slot++) {
          const label = document.createElement('div');
          label.className = 'events-time-label';
          label.textContent = `${pad2(slot)}:00`;
          eventsTimeCol.appendChild(label);
        }
      }

      function buildDays(dayStarts) {
        if (!eventsDays) return;
        eventsDays.innerHTML = '';

        dayStarts.forEach((dayStart, idx) => {
          const col = document.createElement('div');
          col.className = 'events-day';
          col.dataset.dayIndex = String(idx);
          col.style.height = `${SLOTS_PER_DAY * ROW_H}px`;

          for (let slot = 0; slot < SLOTS_PER_DAY; slot++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            col.appendChild(cell);
          }

          eventsDays.appendChild(col);
        });
      }

      function buildHeader(dayStarts, useUTC) {
        if (!eventsHead) return;
        eventsHead.innerHTML = '';
        const corner = document.createElement('div');
        corner.className = 'corner';
        eventsHead.appendChild(corner);

        dayStarts.forEach((d) => {
          const {weekday, date} = fmtDayLabel(d, useUTC);
          const el = document.createElement('div');
          el.className = 'day';
          el.innerHTML = `<span>${weekday}</span><span class="date">${date}</span>`;
          eventsHead.appendChild(el);
        });
      }

      // GOOGLE CALENDAR SOURCES
      // Events calendar (7-day grid) ‚Äî from https://calendar.google.com/calendar/u/0?cid=bWV0YW1vYjNAZ21haWwuY29t
      // (cid decodes to metamob3@gmail.com)
      const EVENTS_CALENDAR_ID = 'metamob3@gmail.com';
      // News calendar (Latest News feed)
      const NEWS_CALENDAR_ID = '3fe5c9f96cadd2b2061a845d709c7666aa83c4272e18325a02a706adecf51058@group.calendar.google.com';

      async function fetchCalendarEvents(dayStarts, useUTC) {
        try {
          console.log('[EVENTS] Fetching calendar events from Google Calendar...');

          // Use the public ICS feed URL
          const icsUrl = `https://calendar.google.com/calendar/ical/${encodeURIComponent(EVENTS_CALENDAR_ID)}/public/basic.ics`;
          console.log('[EVENTS] iCal URL:', icsUrl);

          // Try multiple proxies (some environments block one or the other)
          const proxyUrls = [`https://corsproxy.io/?${encodeURIComponent(icsUrl)}`, `https://r.jina.ai/http://calendar.google.com/calendar/ical/${encodeURIComponent(EVENTS_CALENDAR_ID)}/public/basic.ics`];

          let icsTextRaw = null;
          let lastErr = null;

          for (const u of proxyUrls) {
            try {
              const resp = await fetch(u, {cache: 'no-store'});
              if (!resp.ok) {
                throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
              }
              icsTextRaw = await resp.text();
              console.log('[EVENTS] iCal fetched via:', u);
              break;
            } catch (e) {
              lastErr = e;
              console.warn('[EVENTS] proxy failed:', u, e);
            }
          }

          if (!icsTextRaw) throw lastErr || new Error('Failed to fetch iCal');

          // Unfold folded lines (RFC5545): lines that start with space/tab continue previous line
          const icsText = icsTextRaw.replace(/\r\n[ \t]/g, '').replace(/\n[ \t]/g, '');
          console.log('[EVENTS] iCal data received, length:', icsText.length);

          const events = [];
          const vEvents = icsText.split('BEGIN:VEVENT');
          console.log('[EVENTS] Found', vEvents.length - 1, 'events in calendar');
          if (vEvents.length <= 1) {
            console.warn('[EVENTS] No VEVENT blocks found. First 200 chars:', icsText.slice(0, 200));
          }

          // Map day keys to indexes for robust matching
          const dayIndexByKey = new Map(dayStarts.map((d, i) => [dayKey(d, useUTC), i]));

          vEvents.forEach((v, idx) => {
            if (idx === 0) return;

            const summaryMatch = v.match(/SUMMARY(?:;[^:]*)?:(.*?)(?:\r\n|\n|\r)/);
            const dtStartMatch = v.match(/DTSTART(?:;[^:]*)?:(.*?)(?:\r\n|\n|\r)/);
            const dtEndMatch = v.match(/DTEND(?:;[^:]*)?:(.*?)(?:\r\n|\n|\r)/);
            const locationMatch = v.match(/LOCATION(?:;[^:]*)?:(.*?)(?:\r\n|\n|\r)/);
            const descriptionMatch = v.match(/DESCRIPTION(?:;[^:]*)?:([\s\S]*?)(?=\r\n[A-Z]|\n[A-Z]|\r[A-Z]|END:VEVENT)/);

            if (!summaryMatch || !dtStartMatch) return;

            const title = summaryMatch[1].trim();
            const start = parseIcalDate(dtStartMatch[1]);
            const end = dtEndMatch ? parseIcalDate(dtEndMatch[1]) : new Date(start.getTime() + 7200000);
            const description = descriptionMatch ? descriptionMatch[1].replace(/\\n/g, '\n').trim() : null;

            const k = dayKey(start, useUTC);
            const dayIdx = dayIndexByKey.get(k);

            console.log('[EVENTS] Event:', title, '| start:', start.toString(), '| end:', end.toString(), '| key:', k, '| dayIdx:', dayIdx);

            if (dayIdx === undefined) return;

            events.push({
              dayIndex: dayIdx,
              start,
              end,
              title,
              location: locationMatch ? locationMatch[1].trim() : 'ENCRYPTED NODE',
              description,
              color: 'rgba(138, 43, 226, 0.2)',
            });
          });

          console.log('[EVENTS] Filtered events for current week:', events.length);
          return events;
        } catch (err) {
          console.error('[EVENTS] Calendar fetch error:', err);
          return [];
        }
      }

      function parseIcalDate(str) {
        // Handles common iCal formats:
        // - 20250104 (date only)
        // - 20250104T233000Z (UTC)
        // - 20250104T233000 (local)
        // - 20250104T23300000Z (with seconds)
        if (!str || typeof str !== 'string' || str.length < 8) {
          console.warn('[ICAL] Invalid date string:', str);
          return new Date();
        }

        // trim and remove any stray whitespace
        const raw = str.trim();

        const year = parseInt(raw.slice(0, 4), 10);
        const month = parseInt(raw.slice(4, 6), 10) - 1;
        const day = parseInt(raw.slice(6, 8), 10);

        if (!raw.includes('T')) {
          return new Date(year, month, day);
        }

        let timePart = raw.split('T')[1];
        const isUTC = timePart.endsWith('Z');
        if (isUTC) timePart = timePart.slice(0, -1);

        // HHMMSS or HHMM
        const hour = parseInt(timePart.slice(0, 2), 10) || 0;
        const min = parseInt(timePart.slice(2, 4), 10) || 0;
        const sec = parseInt(timePart.slice(4, 6), 10) || 0;

        if (isUTC) {
          return new Date(Date.UTC(year, month, day, hour, min, sec));
        }

        return new Date(year, month, day, hour, min, sec);
      }

      function clearEventBlocks() {
        document.querySelectorAll('.events-day .event-block').forEach((el) => el.remove());
      }

      function renderEvents(events, useUTC) {
        clearEventBlocks();
        const dayCols = document.querySelectorAll('.events-day');

        events.forEach((evt) => {
          const col = dayCols[evt.dayIndex];
          if (!col) return;

          const startMin = minutesSinceStartOfDay(evt.start, useUTC);
          const endMin = minutesSinceStartOfDay(evt.end, useUTC);

          // Apply 2h minimum span as requested
          let durationMin = endMin - startMin;
          if (durationMin < 120) durationMin = 120;

          const top = (startMin / 60) * ROW_H;
          const height = (durationMin / 60) * ROW_H;

          const block = document.createElement('button');
          block.type = 'button';
          block.className = 'event-block';
          block.style.top = `${top}px`;
          block.style.height = `${height}px`;
          block.style.background = evt.color;
          block.setAttribute('aria-label', `${evt.title} ${fmtTimeHM(evt.start, useUTC)} to ${fmtTimeHM(evt.end, useUTC)}`);

          block.innerHTML = `
                    <div class="title">${evt.title}</div>
                `;

          block.addEventListener('click', () => {
            showEventModal(evt, useUTC);
          });

          col.appendChild(block);
        });
      }

      function showEventModal(event, useUTC) {
        document.getElementById('modalTitle').textContent = 'EVENT DETAILS';
        document.getElementById('modalEventTitle').textContent = event.title;
        document.getElementById('modalEventTime').textContent = `${fmtTimeHM(event.start, useUTC)} - ${fmtTimeHM(event.end, useUTC)}`;
        document.getElementById('modalEventLocation').textContent = event.location;

        const descriptionEl = document.getElementById('modalEventDescription');
        if (event.description) {
          descriptionEl.textContent = event.description;
          descriptionEl.parentElement.style.display = 'block';
        } else {
          descriptionEl.parentElement.style.display = 'none';
        }

        eventModalOverlay.classList.add('active');
      }

      function hideEventModal() {
        eventModalOverlay.classList.remove('active');
      }

      modalClose.addEventListener('click', hideEventModal);
      eventModalOverlay.addEventListener('click', (e) => {
        if (e.target === eventModalOverlay) {
          hideEventModal();
        }
      });

      async function syncCalendarToNews() {
        const newsContainer = document.getElementById('newsContainer');
        if (!newsContainer) return;

        // Always rebuild from the NEWS calendar on refresh
        const icsUrl = `https://calendar.google.com/calendar/ical/${encodeURIComponent(NEWS_CALENDAR_ID)}/public/basic.ics`;

        try {
          // Clear any previous dynamic items (keep the 3 static cards as fallback if the feed fails)
          if (newsContainer.dataset.dynamicInjected === 'true') {
            // remove previously injected items only
            newsContainer.querySelectorAll('[data-news-source="calendar"]').forEach((el) => el.remove());
          }

          const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(icsUrl)}`, {cache: 'no-store'});
          if (!response.ok) {
            console.warn('News calendar fetch failed:', response.status, response.statusText);
            return;
          }

          const icsTextRaw = await response.text();
          const icsText = icsTextRaw.replace(/\r\n[ \t]/g, ''); // unfold folded lines (RFC5545)

          const vEvents = icsText.split('BEGIN:VEVENT');
          const parsed = [];

          vEvents.forEach((v, idx) => {
            if (idx === 0) return;

            const summaryMatch = v.match(/SUMMARY(?:;[^:]*)?:(.*?)(?:\r\n|\n|\r)/);
            const dtStartMatch = v.match(/DTSTART(?:;[^:]*)?:(.*?)(?:\r\n|\n|\r)/);
            const descriptionMatch = v.match(/DESCRIPTION(?:;[^:]*)?:([\s\S]*?)(?=\r\n[A-Z]|\n[A-Z]|\r[A-Z]|END:VEVENT)/);

            if (!summaryMatch || !dtStartMatch) return;

            const title = summaryMatch[1].trim();
            const startDate = parseIcalDate(dtStartMatch[1]);
            const description = descriptionMatch ? descriptionMatch[1].replace(/\\n/g, '\n').trim() : 'OPERATIONAL LOG: DATA SECURED.';

            parsed.push({title, startDate, description});
          });

          // Sort newest first
          parsed.sort((a, b) => b.startDate.getTime() - a.startDate.getTime());

          // If we have events, hide the static cards and inject calendar-driven news
          if (parsed.length > 0) {
            newsContainer.querySelectorAll('.card').forEach((el) => {
              // only hide the original hardcoded cards (first 3)
              if (!el.hasAttribute('data-news-source')) {
                el.style.display = 'none';
              }
            });

            // Inject
            parsed.forEach((evt) => {
              const dateStr = evt.startDate
                .toLocaleDateString('en-US', {
                  month: 'long',
                  day: 'numeric',
                  year: 'numeric',
                })
                .toUpperCase();

              const newsItem = document.createElement('div');
              let hold = String(evt.description || '');
              let split = hold.split('":"');
              let text = split[2] ? split[2].slice(0, -2) : '';

              newsItem.className = 'card flex flex-col md:flex-row gap-4 md:gap-6';
              newsItem.setAttribute('data-news-source', 'calendar');
              newsItem.innerHTML = `
                            <img src="https://ipfs.io/ipfs/${split[1] || ''}" alt="News calendar event thumbnail" class="w-full md:w-48 lg:w-64 h-32 md:h-48 flex-shrink-0 object-cover rounded-lg border-2 border-current shadow-lg" loading="lazy" />
                            <div class="flex-1">
                                <div class="text-xs opacity-70 mb-2" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; letter-spacing: 1px;">${dateStr}</div>
                                <h3 class="text-xl md:text-2xl lg:text-3xl font-bold mb-3 glow-text" style="font-family: 'JetBrains Mono', monospace; font-weight: 100; letter-spacing: 2px;">${evt.title}</h3>
                                <p class="text-xs md:text-sm mb-4" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: 1px; text-transform: none;">${text.length > 220 ? text.substring(0, 220) + '...' : text}</p>
                                <button class="btn" type="button">READ MORE ‚Üí</button>
                            </div>
                        `;
              newsContainer.appendChild(newsItem);
            });

            newsContainer.dataset.dynamicInjected = 'true';
          } else {
            // No events: keep static cards visible
            newsContainer.querySelectorAll('.card').forEach((el) => {
              if (!el.hasAttribute('data-news-source')) {
                el.style.display = '';
              }
            });
            console.warn('News calendar returned 0 events');
          }
        } catch (err) {
          console.error('News sync error:', err);
        }
      }

      async function buildCalendar() {
        if (!eventsHead || !eventsDays || !eventsTimeCol) return;
        const useUTC = tzSelect && tzSelect.value === 'utc';

        const now = new Date();
        console.log('[EVENTS] Now:', now.toString(), '| UTC mode:', useUTC);

        // Next 7 days starting today (matches product requirement and ensures upcoming Monday is visible)
        const base = startOfDay(now, useUTC);
        const dayStarts = Array.from({length: 7}, (_, i) => {
          const d = new Date(base);
          if (useUTC) d.setUTCDate(d.getUTCDate() + i);
          else d.setDate(d.getDate() + i);
          const dayStart = startOfDay(d, useUTC);
          console.log(`[EVENTS] Day ${i}:`, dayStart.toString(), '| key:', dayKey(dayStart, useUTC));
          return dayStart;
        });

        buildHeader(dayStarts, useUTC);
        buildTimeCol();
        buildDays(dayStarts);

        const events = await fetchCalendarEvents(dayStarts, useUTC);
        renderEvents(events, useUTC);

        // Sync news feed from NEWS calendar (separate from events calendar)
        syncCalendarToNews();

        if (events.length === 0) {
          eventsHint.textContent = `NO UPCOMING OPERATIONS SCHEDULED | SYNC: ${fmtTimeHM(now, useUTC)} ${useUTC ? 'UTC' : 'LOCAL'}`;
        } else {
          eventsHint.textContent = `LIVE DATA LOADED (${events.length}) | SYNC: ${fmtTimeHM(now, useUTC)} ${useUTC ? 'UTC' : 'LOCAL'}`;
        }
      }

      if (tzSelect) {
        tzSelect.addEventListener('change', () => buildCalendar());
      }
      if (eventsTodayBtn) {
        eventsTodayBtn.addEventListener('click', () => {
          const eventsGrid = document.getElementById('eventsGrid');
          if (eventsGrid) {
            eventsGrid.scrollTop = 0;
            eventsGrid.scrollLeft = 0;
          }
          buildCalendar();
        });
      }

      // Build calendar on load
      buildCalendar();

      // ============================================
      // THREE.JS BACKGROUND SCENE
      // ============================================
      const bgCanvas = document.getElementById('bg-canvas');
      const bgScene = new THREE.Scene();
      const bgCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      const bgRenderer = new THREE.WebGLRenderer({canvas: bgCanvas, alpha: true, antialias: !isMobile});
      bgRenderer.setSize(window.innerWidth, window.innerHeight);
      bgRenderer.setPixelRatio(Math.min(window.devicePixelRatio, isMobile ? 1.5 : 2));

      // Collections
      const buildings = [];
      const flyingVehicles = [];
      const neonSigns = [];

      // Performance-adjusted settings
      const buildingCount = isLowPerfDevice ? 25 : 50;
      const backgroundBuildingCount = isLowPerfDevice ? 15 : 40;
      const rainCount = isLowPerfDevice ? 2000 : 8000;
      const vehicleCount = isLowPerfDevice ? 3 : 8;

      // ============================================
      // THEME-AWARE MATERIALS SYSTEM
      // ============================================
      const themeAwareMaterials = []; // Store references to all theme-aware materials

      function createThemeMaterial(color, opacity) {
        const mat = new THREE.LineBasicMaterial({color, transparent: true, opacity});
        mat.userData.isThemeAware = true;
        themeAwareMaterials.push(mat);
        return mat;
      }

      function createStaticMaterial(color, opacity) {
        return new THREE.LineBasicMaterial({color, transparent: true, opacity});
      }

      // ============================================
      // SIMPLIFIED BUILDING FUNCTIONS FOR MOBILE
      // ============================================
      function createSimpleBuilding(x, z, height, width) {
        const group = new THREE.Group();
        const violetMat = createThemeMaterial(0x8a2be2, 0.6);
        const cyanMat = createStaticMaterial(0x00ffff, 0.4);

        // Main structure
        const geom = new THREE.BoxGeometry(width, height, width);
        group.add(new THREE.LineSegments(new THREE.EdgesGeometry(geom), violetMat));

        // Spire
        if (Math.random() > 0.5) {
          const spireGeom = new THREE.ConeGeometry(width * 0.2, height * 0.3, 4);
          const spire = new THREE.LineSegments(new THREE.EdgesGeometry(spireGeom), cyanMat);
          spire.position.y = height * 0.65;
          group.add(spire);
        }

        group.position.set(x, height / 2, z);
        return group;
      }

      function createGothicBuilding(x, z) {
        const height = 30 + Math.random() * 40;
        const width = 4 + Math.random() * 4;

        if (isLowPerfDevice) {
          return createSimpleBuilding(x, z, height, width);
        }

        const group = new THREE.Group();
        const violetMat = createThemeMaterial(0x8a2be2, 0.7);
        const cyanMat = createStaticMaterial(0x00ffff, 0.5);
        const magentaMat = createThemeMaterial(0xff00ff, 0.6);

        // Tiered structure
        const tiers = 3 + Math.floor(Math.random() * 3);
        for (let i = 0; i < tiers; i++) {
          const tierHeight = height / tiers;
          const tierWidth = width * (1 - i * 0.15);
          const tierGeom = new THREE.BoxGeometry(tierWidth, tierHeight, tierWidth);
          const tier = new THREE.LineSegments(new THREE.EdgesGeometry(tierGeom), violetMat);
          tier.position.y = i * tierHeight + tierHeight / 2;
          group.add(tier);
        }

        // Spire
        const spireGeom = new THREE.ConeGeometry(width * 0.15, height * 0.25, 6);
        const spire = new THREE.LineSegments(new THREE.EdgesGeometry(spireGeom), magentaMat);
        spire.position.y = height + height * 0.125;
        group.add(spire);

        // Gothic arches
        for (let i = 0; i < 4; i++) {
          const angle = (i / 4) * Math.PI * 2;
          const archGeom = new THREE.TorusGeometry(width * 0.15, 0.05, 6, 8, Math.PI);
          const arch = new THREE.LineSegments(new THREE.EdgesGeometry(archGeom), cyanMat);
          arch.position.set(Math.cos(angle) * width * 0.4, height * 0.3, Math.sin(angle) * width * 0.4);
          arch.rotation.z = Math.PI;
          arch.rotation.y = -angle;
          group.add(arch);
        }

        group.position.set(x, 0, z);
        return group;
      }

      function createFlyingVehicle() {
        const group = new THREE.Group();
        const redMat = createThemeMaterial(0xff0066, 0.8);
        const cyanMat = createStaticMaterial(0x00ffff, 0.5);

        const bodyGeom = new THREE.BoxGeometry(1.5, 0.2, 0.5);
        group.add(new THREE.LineSegments(new THREE.EdgesGeometry(bodyGeom), redMat));

        const cockpitGeom = new THREE.SphereGeometry(0.2, 4, 3);
        const cockpit = new THREE.LineSegments(new THREE.EdgesGeometry(cockpitGeom), cyanMat);
        cockpit.position.set(0.3, 0.2, 0);
        group.add(cockpit);

        group.userData = {
          speed: 0.02 + Math.random() * 0.03,
          yOffset: 20 + Math.random() * 30,
          zOffset: 30 + Math.random() * 80,
        };

        return group;
      }

      function createNeonSign() {
        const group = new THREE.Group();
        const magentaMat = createThemeMaterial(0xff00ff, 0.8);

        const frameGeom = new THREE.BoxGeometry(2, 1.2, 0.1);
        group.add(new THREE.LineSegments(new THREE.EdgesGeometry(frameGeom), magentaMat));

        return group;
      }

      function createRain(count) {
        const positions = new Float32Array(count * 3);

        for (let i = 0; i < count; i++) {
          positions[i * 3] = (Math.random() - 0.5) * 120;
          positions[i * 3 + 1] = Math.random() * 60 + 10;
          positions[i * 3 + 2] = (Math.random() - 0.5) * 120;
        }

        const geometry = new THREE.BufferGeometry();
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

        const material = new THREE.PointsMaterial({
          color: 0x4466aa,
          transparent: true,
          opacity: 0.3,
          size: isMobile ? 0.08 : 0.12,
        });

        return new THREE.Points(geometry, material);
      }

      // ============================================
      // BUILD SCENE
      // ============================================

      // Ground grid
      const gridSize = isLowPerfDevice ? 100 : 160;
      const gridDivisions = isLowPerfDevice ? 40 : 80;
      const grid = new THREE.GridHelper(gridSize, gridDivisions, 0x8a2be2, 0x8a2be2);
      grid.material.transparent = true;
      grid.material.opacity = 0.15;
      grid.material.userData = {isThemeAware: true};
      themeAwareMaterials.push(grid.material);
      bgScene.add(grid);

      // Buildings
      for (let i = 0; i < buildingCount; i++) {
        const side = i % 2 === 0 ? -1 : 1;
        const x = side * (10 + Math.random() * 18);
        const z = 25 + Math.random() * 70;
        const building = createGothicBuilding(x, z);
        buildings.push(building);
        bgScene.add(building);
      }

      // Background buildings
      for (let i = 0; i < backgroundBuildingCount; i++) {
        const x = (Math.random() - 0.5) * 80;
        const z = 80 + Math.random() * 40;
        const building = createGothicBuilding(x, z);
        building.scale.setScalar(0.6 + Math.random() * 0.3);
        buildings.push(building);
        bgScene.add(building);
      }

      // Flying vehicles
      for (let i = 0; i < vehicleCount; i++) {
        const vehicle = createFlyingVehicle();
        vehicle.position.set((Math.random() - 0.5) * 50, vehicle.userData.yOffset, vehicle.userData.zOffset);
        flyingVehicles.push(vehicle);
        bgScene.add(vehicle);
      }

      // Neon signs
      if (!isLowPerfDevice) {
        for (let i = 0; i < 10; i++) {
          const building = buildings[Math.floor(Math.random() * Math.min(buildings.length, 20))];
          const sign = createNeonSign();
          sign.position.set(building.position.x + (Math.random() - 0.5) * 4, 5 + Math.random() * 15, building.position.z + (Math.random() > 0.5 ? 3 : -3));
          neonSigns.push(sign);
          bgScene.add(sign);
        }
      }

      // Rain
      const rain = createRain(rainCount);
      bgScene.add(rain);

      // Fog
      bgScene.fog = new THREE.Fog(0x0a0a0f, isLowPerfDevice ? 5 : 8, isLowPerfDevice ? 40 : 55);

      // Camera
      bgCamera.position.set(0, 1.7, -8);
      bgCamera.lookAt(0, 10, 30);

      // ============================================
      // ANIMATION STATE
      // ============================================
      let scrollProgress = 0;
      let mouseX = 0;
      let mouseY = 0;
      let touchStartX = 0;
      let touchStartY = 0;

      // Mouse movement (desktop)
      document.addEventListener('mousemove', (e) => {
        mouseX = (e.clientX / window.innerWidth - 0.5) * 2;
        mouseY = (e.clientY / window.innerHeight - 0.5) * 2;
      });

      // Touch movement (mobile)
      document.addEventListener(
        'touchstart',
        (e) => {
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;
        },
        {passive: true}
      );

      document.addEventListener(
        'touchmove',
        (e) => {
          const touchX = e.touches[0].clientX;
          const touchY = e.touches[0].clientY;
          mouseX = ((touchX - touchStartX) / window.innerWidth) * 2;
          mouseY = ((touchY - touchStartY) / window.innerHeight) * 2;
        },
        {passive: true}
      );

      document.addEventListener(
        'touchend',
        () => {
          mouseX = 0;
          mouseY = 0;
        },
        {passive: true}
      );

      // Scroll
      let ticking = false;
      window.addEventListener(
        'scroll',
        () => {
          if (!ticking) {
            requestAnimationFrame(() => {
              const maxScroll = document.documentElement.scrollHeight - window.innerHeight;
              scrollProgress = Math.min(window.scrollY / maxScroll, 1);
              ticking = false;
            });
            ticking = true;
          }
        },
        {passive: true}
      );

      // ============================================
      // ANIMATION LOOP
      // ============================================
      let lastTime = 0;
      const targetFPS = isLowPerfDevice ? 30 : 60;
      const frameInterval = 1000 / targetFPS;

      function animateBgScene(currentTime) {
        requestAnimationFrame(animateBgScene);

        // Throttle on low-perf devices
        if (isLowPerfDevice && currentTime - lastTime < frameInterval) {
          return;
        }
        lastTime = currentTime;

        const time = Date.now() * 0.001;

        // Anti-parallax camera movement
        const parallaxStrength = isMobile ? 2 : 4;
        const targetX = -mouseX * parallaxStrength;
        const targetY = mouseY * (isMobile ? 1 : 2);
        bgCamera.position.x += (targetX - bgCamera.position.x) * 0.03;
        bgCamera.position.y += (1.7 + targetY - bgCamera.position.y) * 0.03;

        // Scroll-based camera movement
        const maxZ = isMobile ? 50 : 70;
        const targetZ = -8 + scrollProgress * maxZ;
        bgCamera.position.z += (targetZ - bgCamera.position.z) * 0.06;
        bgCamera.lookAt(0, 12, bgCamera.position.z + 35);

        // Animate rain
        const positions = rain.geometry.attributes.position.array;
        const rainSpeed = isMobile ? 0.6 : 0.8;
        for (let i = 0; i < positions.length / 3; i++) {
          positions[i * 3 + 1] -= rainSpeed + Math.random() * 0.3;
          if (positions[i * 3 + 1] < 5) {
            positions[i * 3 + 1] = 70;
            positions[i * 3] = (Math.random() - 0.5) * 120;
            positions[i * 3 + 2] = (Math.random() - 0.5) * 120;
          }
        }
        rain.geometry.attributes.position.needsUpdate = true;

        // Animate flying vehicles
        flyingVehicles.forEach((vehicle, i) => {
          vehicle.position.x += vehicle.userData.speed;
          if (vehicle.position.x > 35) {
            vehicle.position.x = -35;
            vehicle.position.z = 30 + Math.random() * 60;
          }
          vehicle.position.y = vehicle.userData.yOffset + Math.sin(time * 2 + i) * 0.4;
        });

        // Animate neon signs (only on desktop)
        if (!isLowPerfDevice) {
          neonSigns.forEach((sign, i) => {
            sign.children.forEach((child) => {
              if (child.material) {
                child.material.opacity = 0.5 + Math.sin(time * 8 + i * 2) * 0.3;
              }
            });
          });
        }

        bgRenderer.render(bgScene, bgCamera);
      }

      animateBgScene(0);

      // ============================================
      // THREE.JS LOGO
      // ============================================
      const logoCanvas = document.getElementById('logo-canvas');
      const logoScene = new THREE.Scene();
      const logoCamera = new THREE.PerspectiveCamera(50, 1, 0.1, 100);
      const logoSize = isMobile ? (window.innerWidth < 480 ? 40 : 56) : 72;
      const logoRenderer = new THREE.WebGLRenderer({canvas: logoCanvas, alpha: true, antialias: true});
      logoRenderer.setSize(logoSize, logoSize);
      logoRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

      const dodecaGeom = new THREE.DodecahedronGeometry(0.8, 0);
      const originalPositions = dodecaGeom.attributes.position.array.slice();
      const dodecaEdges = new THREE.EdgesGeometry(dodecaGeom);
      const dodecaMat = new THREE.LineBasicMaterial({color: 0x00ffff, linewidth: 2});
      const logoMesh = new THREE.LineSegments(dodecaEdges, dodecaMat);

      const ringGeom = new THREE.TorusGeometry(1.3, 0.15, 3, 6);
      const ringEdges = new THREE.EdgesGeometry(ringGeom);
      const ringMat = new THREE.LineBasicMaterial({color: 0x8a2be2, transparent: true, opacity: 0.6});
      const ringMesh = new THREE.LineSegments(ringEdges, ringMat);

      logoScene.add(logoMesh);
      logoScene.add(ringMesh);
      logoCamera.position.z = 3.5;

      let lastGlitchTime = 0;

      function animateLogoScene() {
        requestAnimationFrame(animateLogoScene);
        const now = Date.now();

        if (now - lastGlitchTime > 50 + Math.random() * 150) {
          const positions = dodecaGeom.attributes.position.array;
          for (let i = 0; i < positions.length; i++) {
            const jitter = 1 + (Math.random() * 0.02 - 0.01);
            positions[i] = originalPositions[i] * jitter;
          }
          dodecaGeom.attributes.position.needsUpdate = true;
          logoMesh.geometry.dispose();
          logoMesh.geometry = new THREE.EdgesGeometry(dodecaGeom);
          lastGlitchTime = now;
        }

        logoMesh.rotation.x += 0.01;
        logoMesh.rotation.y += 0.015;
        ringMesh.rotation.z -= 0.005;
        ringMesh.rotation.x = Math.sin(now * 0.001) * 0.2;

        logoRenderer.render(logoScene, logoCamera);
      }

      animateLogoScene();

      // ============================================
      // COLOR UPDATES FOR THREE.JS
      // ============================================
      function updateThreeJSColors(palette) {
        const hexColor = parseInt(palette.accent.replace('#', ''), 16);

        // Update all theme-aware materials
        themeAwareMaterials.forEach((mat) => {
          if (mat && mat.color && mat.userData.isThemeAware) {
            mat.color.setHex(hexColor);
          }
        });

        // Update fog
        const fogHex = parseInt(palette.fog.replace('#', ''), 16);
        bgScene.fog.color.setHex(fogHex);

        // Logo: Dodecahedron stays cyan in all modes
        logoMesh.material.color.setHex(0x00ffff);
        // Logo: Ring changes with theme accent color
        ringMesh.material.color.setHex(hexColor);
      }

      // ============================================
      // RESIZE HANDLER
      // ============================================
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          bgCamera.aspect = window.innerWidth / window.innerHeight;
          bgCamera.updateProjectionMatrix();
          bgRenderer.setSize(window.innerWidth, window.innerHeight);

          // Update logo size on resize
          const newLogoSize = window.innerWidth < 480 ? 40 : window.innerWidth < 768 ? 56 : 72;
          logoRenderer.setSize(newLogoSize, newLogoSize);
        }, 100);
      });

      // ============================================
      // FOOTER + LEGAL MODALS
      // ============================================
      const footerYear = document.getElementById('footerYear');
      if (footerYear) footerYear.textContent = String(new Date().getFullYear());

      const legalModalOverlay = document.getElementById('legalModalOverlay');
      const legalModalClose = document.getElementById('legalModalClose');
      const legalModalTitle = document.getElementById('legalModalTitle');
      const legalModalBody = document.getElementById('legalModalBody');
      const privacyLink = document.getElementById('privacyLink');
      const termsLink = document.getElementById('termsLink');

      const ethosModalOverlay = document.getElementById('ethosModalOverlay');
      const ethosModalClose = document.getElementById('ethosModalClose');
      const ethosModalTitle = document.getElementById('ethosModalTitle');
      const ethosModalText = document.getElementById('ethosModalText');
      const ethosModalImage = document.getElementById('ethosModalImage');

      function openEthosModal(title, text) {
        ethosModalTitle.textContent = title;
        ethosModalText.textContent = text;
        ethosModalImage.src = `https://picsum.photos/800/400?random=${Math.random()}`;
        ethosModalOverlay.classList.add('active');
        ethosModalOverlay.setAttribute('aria-hidden', 'false');
        document.body.classList.add('menu-open');
      }

      document.querySelectorAll('.ethos-card').forEach((card) => {
        card.addEventListener('click', () => {
          openEthosModal(card.dataset.title, card.dataset.text);
        });
        card.style.cursor = 'pointer';
      });

      if (ethosModalClose) {
        ethosModalClose.addEventListener('click', () => {
          ethosModalOverlay.classList.remove('active');
          ethosModalOverlay.setAttribute('aria-hidden', 'true');
          document.body.classList.remove('menu-open');
        });
      }

      ethosModalOverlay.addEventListener('click', (e) => {
        if (e.target === ethosModalOverlay) {
          ethosModalOverlay.classList.remove('active');
          ethosModalOverlay.setAttribute('aria-hidden', 'true');
          document.body.classList.remove('menu-open');
        }
      });

      const PRIVACY_TEXT = `PRIVACY POLICY\n\nMETAMOB RESPECTS YOUR PRIVACY. THIS INTERFACE IS A CLIENT-SIDE APPLICATION.\n\n1) DATA WE PROCESS\n- WALLET ADDRESS (IF YOU CONNECT)\n- SELECTED NETWORK\n- BASIC UI PREFERENCES (THEME)\n\n2) COOKIES / LOCAL STORAGE\nWE MAY STORE NON-SENSITIVE UI PREFERENCES (E.G., THEME) LOCALLY TO IMPROVE USER EXPERIENCE.\n\n3) THIRD-PARTY SERVICES\n- CHAIN / WALLET PROVIDERS (E.G., METAMASK)\n- PUBLIC CONTENT DELIVERY NETWORKS\n\n4) SECURITY\nDO NOT SHARE SEED PHRASES OR PRIVATE KEYS. METAMOB WILL NEVER ASK FOR THEM.\n\n5) CONTACT\nIF YOU HAVE QUESTIONS, CONTACT THE METAMOB COLLECTIVE.`;

      const TERMS_TEXT = `TERMS OF SERVICE\n\nBY USING METAMOB, YOU AGREE TO THESE TERMS.\n\n1) NO FINANCIAL ADVICE\nALL CONTENT IS FOR INFORMATIONAL PURPOSES ONLY.\n\n2) WALLET USE\nYOU ARE RESPONSIBLE FOR YOUR WALLET, KEYS, AND TRANSACTIONS.\n\n3) RISK\nBLOCKCHAIN ASSETS ARE VOLATILE. YOU ASSUME ALL RISK.\n\n4) ACCEPTABLE USE\nDO NOT ATTEMPT TO EXPLOIT, DISRUPT, OR REVERSE ENGINEER THE APPLICATION.\n\n5) LIMITATION OF LIABILITY\nTHE APPLICATION IS PROVIDED \"AS IS\" WITHOUT WARRANTIES.\n\n6) CHANGES\nWE MAY UPDATE THESE TERMS AT ANY TIME.`;

      function openLegalModal(kind) {
        if (!legalModalOverlay || !legalModalTitle || !legalModalBody) return;
        if (kind === 'privacy') {
          legalModalTitle.textContent = 'PRIVACY';
          legalModalBody.textContent = PRIVACY_TEXT;
        } else {
          legalModalTitle.textContent = 'TERMS OF SERVICE';
          legalModalBody.textContent = TERMS_TEXT;
        }
        legalModalOverlay.classList.add('active');
        legalModalOverlay.setAttribute('aria-hidden', 'false');
      }

      function closeLegalModal() {
        if (!legalModalOverlay) return;
        legalModalOverlay.classList.remove('active');
        legalModalOverlay.setAttribute('aria-hidden', 'true');
      }

      function openWalletModal(kind, contentHtml) {
        const overlay = document.getElementById('walletActionOverlay');
        const title = document.getElementById('walletActionTitle');
        const body = document.getElementById('walletActionBody');
        if (!overlay || !title || !body) return;
        title.textContent = kind;
        body.innerHTML = contentHtml;
        overlay.classList.add('active');
        overlay.setAttribute('aria-hidden', 'false');
        document.body.classList.add('menu-open');
      }

      function closeWalletModal() {
        const overlay = document.getElementById('walletActionOverlay');
        if (!overlay) return;
        overlay.classList.remove('active');
        overlay.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('menu-open');
      }

      const walletActionClose = document.getElementById('walletActionClose');
      if (walletActionClose) walletActionClose.addEventListener('click', closeWalletModal);
      const walletActionOverlay = document.getElementById('walletActionOverlay');
      if (walletActionOverlay) {
        walletActionOverlay.addEventListener('click', (e) => {
          if (e.target === walletActionOverlay) closeWalletModal();
        });
      }

      if (privacyLink) privacyLink.addEventListener('click', () => openLegalModal('privacy'));
      if (termsLink) termsLink.addEventListener('click', () => openLegalModal('terms'));
      if (legalModalClose) legalModalClose.addEventListener('click', closeLegalModal);
      if (legalModalOverlay) {
        legalModalOverlay.addEventListener('click', (e) => {
          if (e.target === legalModalOverlay) closeLegalModal();
        });
      }

      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeLegalModal();
          closeWalletModal();
          hideEventModal();
          const pv = document.getElementById('productVariantsOverlay');
          const pd = document.getElementById('productDetailOverlay');
          if (pv && pv.classList.contains('active')) {
            pv.classList.remove('active');
            pv.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('menu-open');
          }
          if (pd && pd.classList.contains('active')) {
            pd.classList.remove('active');
            pd.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('menu-open');
          }
        }
      });

      // ============================================
      // MOBMAP LIST GENERATOR
      // ============================================
      const mobmapData = ['LVL 1 - Join the Mob - Connect wallet , Setup account - ‚úÖ', 'LVL 2 - Know the Mob - Join Spaces, AMAs and Meets - ‚úÖ', 'LVL 3 - Grab your ID - Mint a Soulbound NFT Profile - üîí', 'LVL 4 - Affiliated to the Mob - ... - üîí', 'LVL 5 - Grow with the Mob - ... - üîí', 'LVL 6 - Be loyal to the Mob - ... - üîí', 'LVL 7 - Rely on the Mob - ... - üîí', 'LVL 8 - Send Mob to the Moon - ... - üîí'];

      function renderMobmap() {
        const container = document.getElementById('mobmap-list');
        if (!container) return;

        container.innerHTML = '';
        mobmapData.forEach((item) => {
          const parts = item.split(' - ');
          const row = document.createElement('div');
          row.className = 'grid grid-cols-[80px_1fr_2fr_40px] md:grid-cols-[100px_1.5fr_2.5fr_60px] items-center text-[10px] md:text-xs py-3 px-4 bg-[#0a0a0f] border-b border-white/5 last:border-0 hover:bg-white/5 transition-colors';
          row.style.backgroundColor = 'transparent';
          row.style.textTransform = 'none';
          row.style.fontFamily = "'JetBrains Mono', monospace";

          parts.forEach((part, i) => {
            const cell = document.createElement('div');
            cell.textContent = part;
            if (i === 0) cell.style.fontWeight = '800';
            if (i === 2) cell.style.opacity = '0.7';
            if (i === 3) {
              cell.style.textAlign = 'right';
              cell.style.fontSize = '1.1em';
            }
            row.appendChild(cell);
          });

          container.appendChild(row);
        });
      }

      renderMobmap();

      // ============================================
      // SHOP: PRODUCT CATALOG + MODALS
      // ============================================
      const PRODUCT_CATALOG = {
        hoodie: {
          category: 'APPAREL / HOODIE',
          display: 'MOB HOODIE',
          blurb: 'Heavyweight wireframe textile. Stealth fit.',
          variants: [
            {
              id: 'hoodie-black',
              name: 'MOB HOODIE / BLACKOUT',
              price: '0.05 ETH',
              image: 'https://picsum.photos/800?random=110',
              desc: 'Matte blackout cotton blend with micro-embroidered MOB glyph.',
              specs: ['450gsm fleece', 'Hidden inner pocket', 'Reinforced seams', 'Oversized fit'],
              story: 'Forged in the alleyways. Built to disappear under neon rain.',
            },
            {
              id: 'hoodie-violet',
              name: 'MOB HOODIE / VIOLET TRACE',
              price: '0.055 ETH',
              image: 'https://picsum.photos/800?random=111',
              desc: 'Violet-trace piping with reflective thread lines that react to streetlight.',
              specs: ['Reflective piping', 'Anti-pilling finish', 'Double-layer hood', 'Street-ready'],
              story: 'A signal in the fog. A silhouette in the code.',
            },
            {
              id: 'hoodie-core',
              name: 'MOB HOODIE / CORE EDITION',
              price: '0.06 ETH',
              image: 'https://picsum.photos/800?random=112',
              desc: 'Core edition with minimal branding and maximum durability.',
              specs: ['Ribbed cuffs', 'Kangaroo pocket', 'Heavy drawcord', 'Wash-resistant print'],
              story: 'The uniform of operators who never log off.',
            },
          ],
        },
        tshirt: {
          category: 'APPAREL / T-SHIRT',
          display: 'MOB T-SHIRT',
          blurb: 'Organic cotton with encrypted print.',
          variants: [
            {
              id: 'tee-white',
              name: 'MOB T-SHIRT / WHITE NOISE',
              price: '0.02 ETH',
              image: 'https://picsum.photos/800?random=120',
              desc: 'Clean base layer with subtle barcode print under collar.',
              specs: ['200gsm', 'Pre-shrunk', 'Soft touch', 'Minimal seam map'],
              story: 'The quiet layer. The loud intent.',
            },
            {
              id: 'tee-black',
              name: 'MOB T-SHIRT / BLACK SIGNAL',
              price: '0.022 ETH',
              image: 'https://picsum.photos/800?random=121',
              desc: 'Black tee with UV-reactive glyphs and city-grid backprint.',
              specs: ['UV-reactive ink', 'Reinforced neck', 'Street cut', 'Breathable'],
              story: 'Your presence, encrypted.',
            },
            {
              id: 'tee-core',
              name: 'MOB T-SHIRT / CORE',
              price: '0.018 ETH',
              image: 'https://picsum.photos/800?random=122',
              desc: 'Core edition with front micrologo and clean back.',
              specs: ['Organic cotton', 'Tagless', 'Durable print', 'Regular fit'],
              story: 'Built for everyday ops.',
            },
          ],
        },
        cap: {
          category: 'APPAREL / CAP',
          display: 'MOB CAP',
          blurb: 'Signal blocking fabric. Cyberpunk fit.',
          variants: [
            {
              id: 'cap-black',
              name: 'MOB CAP / BLACKOUT',
              price: '0.015 ETH',
              image: 'https://picsum.photos/800?random=130',
              desc: 'Low-profile baseball cap with stitched MOB mark.',
              specs: ['Adjustable strap', 'Moisture band', 'Curved visor', '6-panel crown'],
              story: 'A brim against the glare. A face against the scanners.',
            },
            {
              id: 'cap-violet',
              name: 'MOB CAP / VIOLET EDGE',
              price: '0.017 ETH',
              image: 'https://picsum.photos/800?random=131',
              desc: 'Violet edge stitch with reflective underbill.',
              specs: ['Reflective underbill', '6-panel', 'Stitched vents', 'Operator cut'],
              story: 'Mark your lane without revealing your route.',
            },
            {
              id: 'cap-core',
              name: 'MOB CAP / CORE',
              price: '0.014 ETH',
              image: 'https://picsum.photos/800?random=132',
              desc: 'Core cap‚Äîclean silhouette, minimal branding.',
              specs: ['Curved brim', 'Adjustable', 'Lightweight', 'All-season'],
              story: 'Minimal signal. Maximum utility.',
            },
          ],
        },
        server: {
          category: 'INFRA / VIRTUAL SERVER',
          display: 'VIRTUAL SERVER',
          blurb: 'High performance node in the cloud.',
          variants: [
            {
              id: 'server-starter',
              name: 'NODE / STARTER',
              price: '0.05 ETH / MO',
              image: 'https://picsum.photos/800?random=140',
              desc: 'Entry node for indexing and light workloads.',
              specs: ['2 vCPU', '4GB RAM', '100GB NVMe', 'Daily snapshots'],
              story: 'Spin up. Sync fast. Stay quiet.',
            },
            {
              id: 'server-pro',
              name: 'NODE / PRO',
              price: '0.1 ETH / MO',
              image: 'https://picsum.photos/800?random=141',
              desc: 'Production-grade node with higher throughput.',
              specs: ['4 vCPU', '16GB RAM', '500GB NVMe', 'DDoS shield'],
              story: 'For operators running full-time pipelines.',
            },
            {
              id: 'server-archon',
              name: 'NODE / ARCHON',
              price: '0.2 ETH / MO',
              image: 'https://picsum.photos/800?random=142',
              desc: 'High availability cluster-ready instance.',
              specs: ['8 vCPU', '32GB RAM', '1TB NVMe', 'Multi-region'],
              story: 'When uptime is the mission.',
            },
          ],
        },
        tracker: {
          category: 'HARDWARE / TRACKING DEVICE',
          display: 'TRACKING DEVICE',
          blurb: 'GPS-free decentralized tracking.',
          variants: [
            {
              id: 'tracker-lite',
              name: 'TRACKER / LITE',
              price: '0.06 ETH',
              image: 'https://picsum.photos/800?random=150',
              desc: 'Compact device for short-range mesh tracking.',
              specs: ['Mesh mode', '7-day battery', 'Water resistant', 'NFC pairing'],
              story: 'Follow the signal. Not the satellites.',
            },
            {
              id: 'tracker-pro',
              name: 'TRACKER / PRO',
              price: '0.08 ETH',
              image: 'https://picsum.photos/800?random=151',
              desc: 'Long-range device with hardened casing.',
              specs: ['30-day battery', 'Rugged shell', 'Encrypted beacons', 'Tamper alert'],
              story: 'For routes that can‚Äôt be mapped.',
            },
            {
              id: 'tracker-ops',
              name: 'TRACKER / OPS',
              price: '0.1 ETH',
              image: 'https://picsum.photos/800?random=152',
              desc: 'Ops edition for persistent tracking and alerts.',
              specs: ['Real-time alerts', 'Multi-asset tags', 'Silent mode', 'Mesh relay'],
              story: 'Eyes on everything. Quietly.',
            },
          ],
        },
        nft: {
          category: 'IDENTITY / MOB NFT',
          display: 'MOB NFT',
          blurb: 'Unique identity for the metaverse.',
          variants: [
            {
              id: 'nft-soulbound',
              name: 'MOB NFT / SOULBOUND ID',
              price: '0.25 ETH',
              image: 'https://picsum.photos/800?random=160',
              desc: 'Non-transferable identity token with reputation hooks.',
              specs: ['SBT', 'Reputation', 'Composable', 'Onchain metadata'],
              story: 'Your ID in the dark city.',
            },
            {
              id: 'nft-sigil',
              name: 'MOB NFT / SIGIL',
              price: '0.3 ETH',
              image: 'https://picsum.photos/800?random=161',
              desc: 'Sigil edition with enhanced perks and access flags.',
              specs: ['Access gates', 'Perk modules', 'Upgradeable', 'Badge layers'],
              story: 'A mark that opens doors.',
            },
            {
              id: 'nft-legend',
              name: 'MOB NFT / LEGEND',
              price: '0.5 ETH',
              image: 'https://picsum.photos/800?random=162',
              desc: 'Legend tier for early operators and builders.',
              specs: ['Founder perks', 'Priority drops', 'Private channels', 'Onchain credits'],
              story: 'For those who built the first streets.',
            },
          ],
        },
      };

      const productVariantsOverlay = document.getElementById('productVariantsOverlay');
      const productVariantsModal = document.getElementById('productVariantsModal');
      const productVariantsClose = document.getElementById('productVariantsClose');
      const productVariantsTitle = document.getElementById('productVariantsTitle');
      const productVariantsSubtitle = document.getElementById('productVariantsSubtitle');
      const variantGrid = document.getElementById('variantGrid');

      const productDetailOverlay = document.getElementById('productDetailOverlay');
      const productDetail = document.getElementById('productDetail');
      const productDetailClose = document.getElementById('productDetailClose');
      const productDetailBackBtn = document.getElementById('productDetailBackBtn');

      const productDetailKicker = document.getElementById('productDetailKicker');
      const productDetailTitle = document.getElementById('productDetailTitle');
      const productDetailImage = document.getElementById('productDetailImage');
      const productDetailStory = document.getElementById('productDetailStory');
      const productDetailCategory = document.getElementById('productDetailCategory');
      const productDetailPrice = document.getElementById('productDetailPrice');
      const productDetailDescription = document.getElementById('productDetailDescription');
      const productDetailSpecs = document.getElementById('productDetailSpecs');
      const productDetailBuyBtn = document.getElementById('productDetailBuyBtn');
      const productDetailSecondaryBtn = document.getElementById('productDetailSecondaryBtn');
      const productDetailFootnote = document.getElementById('productDetailFootnote');

      const toast = document.getElementById('toast');
      let lastVariantsCategoryKey = null;

      function showToast(msg) {
        if (!toast) return;
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 1700);
      }

      function openOverlay(overlay) {
        overlay.classList.add('active');
        overlay.setAttribute('aria-hidden', 'false');
        document.body.classList.add('menu-open');
      }

      function closeOverlay(overlay) {
        overlay.classList.remove('active');
        overlay.setAttribute('aria-hidden', 'true');
        // Only unlock scroll if no other overlays are open
        const anyOpen = document.querySelector('.mobile-menu-overlay.active, .event-modal-overlay.active, .legal-modal-overlay.active, .product-overlay.active');
        if (!anyOpen) document.body.classList.remove('menu-open');
      }

      function getProductKeyFromCard(card) {
        const h3 = card.querySelector('h3');
        const title = (h3 ? h3.textContent : '').toUpperCase();
        if (title.includes('HOODIE')) return 'hoodie';
        if (title.includes('T-SHIRT') || title.includes('TSHIRT')) return 'tshirt';
        if (title.includes('CAP')) return 'cap';
        if (title.includes('SERVER')) return 'server';
        if (title.includes('TRACKING')) return 'tracker';
        if (title.includes('NFT')) return 'nft';
        return null;
      }

      function ensureShopCardsInteractive() {
        // Deactivated: Coming Soon mode enabled.
        /*
            const shopSection = document.getElementById('mob-market');
            if (!shopSection) return;

            const cards = shopSection.querySelectorAll('.grid-container .card');
            cards.forEach(card => {
                const key = getProductKeyFromCard(card);
                if (!key) return;

                card.classList.add('product-card');
                card.setAttribute('role', 'button');
                card.setAttribute('tabindex', '0');
                card.dataset.product = key;

                // Ensure a view-variants button exists
                if (!card.querySelector('[data-action="variants"]')) {
                    const btn = document.createElement('button');
                    btn.className = 'btn';
                    btn.type = 'button';
                    btn.dataset.action = 'variants';
                    btn.textContent = 'VIEW VARIANTS ‚Üí';
                    card.appendChild(btn);
                }

                const open = (ev) => {
                    if (ev) ev.preventDefault();
                    openVariants(key);
                };

                card.addEventListener('click', (e) => {
                    const target = e.target;
                    if (target && target.closest && target.closest('button')) {
                        const b = target.closest('button');
                        if (b && b.dataset.action === 'variants') {
                            open(e);
                            return;
                        }
                    }
                    open(e);
                });

                card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        openVariants(key);
                    }
                });
            });
            */
      }

      function openVariants(categoryKey) {
        const cat = PRODUCT_CATALOG[categoryKey];
        if (!cat) return;

        lastVariantsCategoryKey = categoryKey;
        if (productVariantsTitle) productVariantsTitle.textContent = `${cat.display} / VARIANTS`;
        if (productVariantsSubtitle) productVariantsSubtitle.textContent = cat.category;
        if (variantGrid) variantGrid.innerHTML = '';

        cat.variants.forEach((v) => {
          const tile = document.createElement('div');
          tile.className = 'variant-tile';
          tile.innerHTML = `
                    <img class="variant-img" src="${v.image}" alt="${v.name}" loading="lazy" />
                    <div class="variant-meta">
                        <div class="variant-name">${v.name}</div>
                        <div class="variant-desc">${v.desc}</div>
                        <div class="variant-actions">
                            <div class="price-tag">${v.price}</div>
                            <div class="flex gap-2">
                                <button class="btn" type="button" data-action="details" data-id="${v.id}">DETAILS</button>
                                <button class="btn" type="button" data-action="buy" data-id="${v.id}">BUY NOW</button>
                            </div>
                        </div>
                    </div>
                `;
          variantGrid.appendChild(tile);
        });

        // Delegate clicks
        variantGrid.onclick = (e) => {
          const btn = e.target.closest('button');
          if (!btn) return;
          const id = btn.dataset.id;
          const action = btn.dataset.action;
          if (!id || !action) return;
          if (action === 'buy') {
            showToast(`ORDER QUEUED: ${id.toUpperCase()}`);
          }
          if (action === 'details') {
            openProductDetail(categoryKey, id);
          }
        };

        openOverlay(productVariantsOverlay);
      }

      function handleWalletAction(action) {
        const shortAddress = walletState.address ? formatAddress(walletState.address) : '0x0000...0000';
        const fullAddress = walletState.address || 'Not connected';
        const network = document.getElementById('currentNetwork')?.textContent || 'Base';

        if (action === 'account') {
          const html = `
                    <div class="wallet-field-row">
                        <div class="wallet-field-label">NAME</div>
                        <input id="acctName" class="wallet-field-input" type="text" value="" placeholder="Your name" disabled>
                        <button class="btn wallet-edit-btn" type="button" data-edit="acctName">EDIT</button>
                    </div>

                    <div class="wallet-field-row">
                        <div class="wallet-field-label">EMAIL</div>
                        <input id="acctEmail" class="wallet-field-input" type="email" value="" placeholder="name@domain.com" disabled>
                        <button class="btn wallet-edit-btn" type="button" data-edit="acctEmail">EDIT</button>
                    </div>

                    <div class="wallet-field-row">
                        <div class="wallet-field-label">PHONE</div>
                        <div class="wallet-phone-group">
                            <select id="acctPhonePrefix" class="wallet-prefix-select" disabled>
                                <option value="+93">üá¶üá´ AF (+93)</option>
                                <option value="+355">üá¶üá± AL (+355)</option>
                                <option value="+213">üá©üáø DZ (+213)</option>
                                <option value="+1684">üá¶üá∏ AS (+1684)</option>
                                <option value="+376">üá¶üá© AD (+376)</option>
                                <option value="+244">üá¶üá¥ AO (+244)</option>
                                <option value="+1264">üá¶üáÆ AI (+1264)</option>
                                <option value="+1268">üá¶üá¨ AG (+1268)</option>
                                <option value="+54">üá¶üá∑ AR (+54)</option>
                                <option value="+374">üá¶üá≤ AM (+374)</option>
                                <option value="+297">üá¶üáº AW (+297)</option>
                                <option value="+61">üá¶üá∫ AU (+61)</option>
                                <option value="+43">üá¶üáπ AT (+43)</option>
                                <option value="+994">üá¶üáø AZ (+994)</option>
                                <option value="+1242">üáßüá∏ BS (+1242)</option>
                                <option value="+973">üáßüá≠ BH (+973)</option>
                                <option value="+880">üáßüá© BD (+880)</option>
                                <option value="+1246">üáßüáß BB (+1246)</option>
                                <option value="+375">üáßüáæ BY (+375)</option>
                                <option value="+32">üáßüá™ BE (+32)</option>
                                <option value="+501">üáßüáø BZ (+501)</option>
                                <option value="+229">üáßüáØ BJ (+229)</option>
                                <option value="+1441">üáßüá≤ BM (+1441)</option>
                                <option value="+975">üáßüáπ BT (+975)</option>
                                <option value="+591">üáßüá¥ BO (+591)</option>
                                <option value="+387">üáßüá¶ BA (+387)</option>
                                <option value="+267">üáßüáº BW (+267)</option>
                                <option value="+55">üáßüá∑ BR (+55)</option>
                                <option value="+246">üáÆüá¥ IO (+246)</option>
                                <option value="+673">üáßüá≥ BN (+673)</option>
                                <option value="+359">üáßüá¨ BG (+359)</option>
                                <option value="+226">üáßüá´ BF (+226)</option>
                                <option value="+257">üáßüáÆ BI (+257)</option>
                                <option value="+855">üá∞üá≠ KH (+855)</option>
                                <option value="+237">üá®üá≤ CM (+237)</option>
                                <option value="+1">üá®üá¶ CA (+1)</option>
                                <option value="+238">üá®üáª CV (+238)</option>
                                <option value="+1345">üá∞üáæ KY (+1345)</option>
                                <option value="+236">üá®üá´ CF (+236)</option>
                                <option value="+235">üáπüá© TD (+235)</option>
                                <option value="+56">üá®üá± CL (+56)</option>
                                <option value="+86">üá®üá≥ CN (+86)</option>
                                <option value="+61">üá®üáΩ CX (+61)</option>
                                <option value="+61">üá®üá® CC (+61)</option>
                                <option value="+57">üá®üá¥ CO (+57)</option>
                                <option value="+269">üá∞üá≤ KM (+269)</option>
                                <option value="+242">üá®üá¨ CG (+242)</option>
                                <option value="+243">üá®üá© CD (+243)</option>
                                <option value="+682">üá®üá∞ CK (+682)</option>
                                <option value="+506">üá®üá∑ CR (+506)</option>
                                <option value="+225">üá®üáÆ CI (+225)</option>
                                <option value="+385">üá≠üá∑ HR (+385)</option>
                                <option value="+53">üá®üá∫ CU (+53)</option>
                                <option value="+357">üá®üáæ CY (+357)</option>
                                <option value="+420">üá®üáø CZ (+420)</option>
                                <option value="+45">üá©üá∞ DK (+45)</option>
                                <option value="+253">üá©üáØ DJ (+253)</option>
                                <option value="+1767">üá©üá≤ DM (+1767)</option>
                                <option value="+1809">üá©üá¥ DO (+1809)</option>
                                <option value="+593">üá™üá® EC (+593)</option>
                                <option value="+20">üá™üá¨ EG (+20)</option>
                                <option value="+503">üá∏üáª SV (+503)</option>
                                <option value="+240">üá¨üá∂ GQ (+240)</option>
                                <option value="+291">üá™üá∑ ER (+291)</option>
                                <option value="+372">üá™üá™ EE (+372)</option>
                                <option value="+251">üá™üáπ ET (+251)</option>
                                <option value="+500">üá´üá∞ FK (+500)</option>
                                <option value="+298">üá´üá¥ FO (+298)</option>
                                <option value="+679">üá´üáØ FJ (+679)</option>
                                <option value="+358">üá´üáÆ FI (+358)</option>
                                <option value="+33">üá´üá∑ FR (+33)</option>
                                <option value="+594">üá¨üá´ GF (+594)</option>
                                <option value="+689">üáµüá´ PF (+689)</option>
                                <option value="+241">üá¨üá¶ GA (+241)</option>
                                <option value="+220">üá¨üá≤ GM (+220)</option>
                                <option value="+995">üá¨üá™ GE (+995)</option>
                                <option value="+49">üá©üá™ DE (+49)</option>
                                <option value="+233">üá¨üá≠ GH (+233)</option>
                                <option value="+350">üá¨üáÆ GI (+350)</option>
                                <option value="+30">üá¨üá∑ GR (+30)</option>
                                <option value="+299">üá¨üá± GL (+299)</option>
                                <option value="+1473">üá¨üá© GD (+1473)</option>
                                <option value="+590">üá¨üáµ GP (+590)</option>
                                <option value="+1671">üá¨üá∫ GU (+1671)</option>
                                <option value="+502">üá¨üáπ GT (+502)</option>
                                <option value="+224">üá¨üá≥ GN (+224)</option>
                                <option value="+245">üá¨üáº GW (+245)</option>
                                <option value="+592">üá¨üáæ GY (+592)</option>
                                <option value="+509">üá≠üáπ HT (+509)</option>
                                <option value="+504">üá≠üá≥ HN (+504)</option>
                                <option value="+852">üá≠üá∞ HK (+852)</option>
                                <option value="+36">üá≠üá∫ HU (+36)</option>
                                <option value="+354">üáÆüá∏ IS (+354)</option>
                                <option value="+91">üáÆüá≥ IN (+91)</option>
                                <option value="+62">üáÆüá© ID (+62)</option>
                                <option value="+98">üáÆüá∑ IR (+98)</option>
                                <option value="+964">üáÆüá∂ IQ (+964)</option>
                                <option value="+353">üáÆüá™ IE (+353)</option>
                                <option value="+972">üáÆüá± IL (+972)</option>
                                <option value="+39">üáÆüáπ IT (+39)</option>
                                <option value="+1876">üáØüá≤ JM (+1876)</option>
                                <option value="+81">üáØüáµ JP (+81)</option>
                                <option value="+962">üáØüá¥ JO (+962)</option>
                                <option value="+7">üá∞üáø KZ (+7)</option>
                                <option value="+254">üá∞üá™ KE (+254)</option>
                                <option value="+686">üá∞üáÆ KI (+686)</option>
                                <option value="+850">üá∞üáµ KP (+850)</option>
                                <option value="+82">üá∞üá∑ KR (+82)</option>
                                <option value="+965">üá∞üáº KW (+965)</option>
                                <option value="+996">üá∞üá¨ KG (+996)</option>
                                <option value="+856">üá±üá¶ LA (+856)</option>
                                <option value="+371">üá±üáª LV (+371)</option>
                                <option value="+961">üá±üáß LB (+961)</option>
                                <option value="+266">üá±üá∏ LS (+266)</option>
                                <option value="+231">üá±üá∑ LR (+231)</option>
                                <option value="+218">üá±üáæ LY (+218)</option>
                                <option value="+423">üá±üáÆ LI (+423)</option>
                                <option value="+370">üá±üáπ LT (+370)</option>
                                <option value="+352">üá±üá∫ LU (+352)</option>
                                <option value="+853">üá≤üá¥ MO (+853)</option>
                                <option value="+389">üá≤üá∞ MK (+389)</option>
                                <option value="+261">üá≤üá¨ MG (+261)</option>
                                <option value="+265">üá≤üáº MW (+265)</option>
                                <option value="+60">üá≤üáæ MY (+60)</option>
                                <option value="+960">üá≤üáª MV (+960)</option>
                                <option value="+223">üá≤üá± ML (+223)</option>
                                <option value="+356">üá≤üáπ MT (+356)</option>
                                <option value="+692">üá≤üá≠ MH (+692)</option>
                                <option value="+596">üá≤üá∂ MQ (+596)</option>
                                <option value="+222">üá≤üá∑ MR (+222)</option>
                                <option value="+230">üá≤üá∫ MU (+230)</option>
                                <option value="+262">üáæüáπ YT (+262)</option>
                                <option value="+52">üá≤üáΩ MX (+52)</option>
                                <option value="+691">üá´üá≤ FM (+691)</option>
                                <option value="+373">üá≤üá© MD (+373)</option>
                                <option value="+377">üá≤üá® MC (+377)</option>
                                <option value="+976">üá≤üá≥ MN (+976)</option>
                                <option value="+1664">üá≤üá∏ MS (+1664)</option>
                                <option value="+212">üá≤üá¶ MA (+212)</option>
                                <option value="+258">üá≤üáø MZ (+258)</option>
                                <option value="+95">üá≤üá≤ MM (+95)</option>
                                <option value="+264">üá≥üá¶ NA (+264)</option>
                                <option value="+674">üá≥üá∑ NR (+674)</option>
                                <option value="+977">üá≥üáµ NP (+977)</option>
                                <option value="+31">üá≥üá± NL (+31)</option>
                                <option value="+599">üá¶üá≥ AN (+599)</option>
                                <option value="+687">üá≥üá® NC (+687)</option>
                                <option value="+64">üá≥üáø NZ (+64)</option>
                                <option value="+505">üá≥üáÆ NI (+505)</option>
                                <option value="+227">üá≥üá™ NE (+227)</option>
                                <option value="+234">üá≥üá¨ NG (+234)</option>
                                <option value="+683">üá≥üá∫ NU (+683)</option>
                                <option value="+672">üá≥üá´ NF (+672)</option>
                                <option value="+1670">üá≤üáµ MP (+1670)</option>
                                <option value="+47">üá≥üá¥ NO (+47)</option>
                                <option value="+968">üá¥üá≤ OM (+968)</option>
                                <option value="+92">üáµüá∞ PK (+92)</option>
                                <option value="+680">üáµüáº PW (+680)</option>
                                <option value="+970">üáµüá∏ PS (+970)</option>
                                <option value="+507">üáµüá¶ PA (+507)</option>
                                <option value="+675">üáµüá¨ PG (+675)</option>
                                <option value="+595">üáµüáæ PY (+595)</option>
                                <option value="+51">üáµüá™ PE (+51)</option>
                                <option value="+63">üáµüá≠ PH (+63)</option>
                                <option value="+0">üáµüá≥ PN (+0)</option>
                                <option value="+48">üáµüá± PL (+48)</option>
                                <option value="+351">üáµüáπ PT (+351)</option>
                                <option value="+1787">üáµüá∑ PR (+1787)</option>
                                <option value="+974">üá∂üá¶ QA (+974)</option>
                                <option value="+262">üá∑üá™ RE (+262)</option>
                                <option value="+40">üá∑üá¥ RO (+40)</option>
                                <option value="+7">üá∑üá∫ RU (+7)</option>
                                <option value="+250">üá∑üáº RW (+250)</option>
                                <option value="+290">üá∏üá≠ SH (+290)</option>
                                <option value="+1869">üá∞üá≥ KN (+1869)</option>
                                <option value="+1758">üá±üá® LC (+1758)</option>
                                <option value="+508">üáµüá≤ PM (+508)</option>
                                <option value="+1784">üáªüá® VC (+1784)</option>
                                <option value="+685">üáºüá∏ WS (+685)</option>
                                <option value="+378">üá∏üá≤ SM (+378)</option>
                                <option value="+239">üá∏üáπ ST (+239)</option>
                                <option value="+966">üá∏üá¶ SA (+966)</option>
                                <option value="+221">üá∏üá≥ SN (+221)</option>
                                <option value="+381">üá∑üá∏ RS (+381)</option>
                                <option value="+248">üá∏üá® SC (+248)</option>
                                <option value="+232">üá∏üá± SL (+232)</option>
                                <option value="+65">üá∏üá¨ SG (+65)</option>
                                <option value="+421">üá∏üá∞ SK (+421)</option>
                                <option value="+386">üá∏üáÆ SI (+386)</option>
                                <option value="+677">üá∏üáß SB (+677)</option>
                                <option value="+252">üá∏üá¥ SO (+252)</option>
                                <option value="+27">üáøüá¶ ZA (+27)</option>
                                <option value="+34">üá™üá∏ ES (+34)</option>
                                <option value="+94">üá±üá∞ LK (+94)</option>
                                <option value="+249">üá∏üá© SD (+249)</option>
                                <option value="+597">üá∏üá∑ SR (+597)</option>
                                <option value="+268">üá∏üáø SZ (+268)</option>
                                <option value="+46">üá∏üá™ SE (+46)</option>
                                <option value="+41">üá®üá≠ CH (+41)</option>
                                <option value="+963">üá∏üáæ SY (+963)</option>
                                <option value="+886">üáπüáº TW (+886)</option>
                                <option value="+992">üáπüáØ TJ (+992)</option>
                                <option value="+255">üáπüáø TZ (+255)</option>
                                <option value="+66">üáπüá≠ TH (+66)</option>
                                <option value="+670">üáπüá± TL (+670)</option>
                                <option value="+228">üáπüá¨ TG (+228)</option>
                                <option value="+690">üáπüá∞ TK (+690)</option>
                                <option value="+676">üáπüá¥ TO (+676)</option>
                                <option value="+1868">üáπüáπ TT (+1868)</option>
                                <option value="+216">üáπüá≥ TN (+216)</option>
                                <option value="+90">üáπüá∑ TR (+90)</option>
                                <option value="+993">üáπüá≤ TM (+993)</option>
                                <option value="+1649">üáπüá® TC (+1649)</option>
                                <option value="+688">üáπüáª TV (+688)</option>
                                <option value="+256">üá∫üá¨ UG (+256)</option>
                                <option value="+380">üá∫üá¶ UA (+380)</option>
                                <option value="+971">üá¶üá™ AE (+971)</option>
                                <option value="+44">üá¨üáß GB (+44)</option>
                                <option value="+1">üá∫üá∏ US (+1)</option>
                                <option value="+598">üá∫üáæ UY (+598)</option>
                                <option value="+998">üá∫üáø UZ (+998)</option>
                                <option value="+678">üáªüá∫ VU (+678)</option>
                                <option value="+379">üáªüá¶ VA (+379)</option>
                                <option value="+58">üáªüá™ VE (+58)</option>
                                <option value="+84">üáªüá≥ VN (+84)</option>
                                <option value="+1284">üáªüá¨ VG (+1284)</option>
                                <option value="+1340">üáªüáÆ VI (+1340)</option>
                                <option value="+681">üáºüá´ WF (+681)</option>
                                <option value="+967">üáæüá™ YE (+967)</option>
                                <option value="+260">üáøüá≤ ZM (+260)</option>
                                <option value="+263">üáøüáº ZW (+263)</option>
                            </select>
                            <input id="acctPhone" class="wallet-field-input" type="tel" value="" placeholder="Phone number" disabled>
                        </div>
                        <button class="btn wallet-edit-btn" type="button" data-edit-phone="acctPhone">EDIT</button>
                    </div>

                    <div class="wallet-field-row">
                        <div class="wallet-field-label">X.COM</div>
                        <input id="acctX" class="wallet-field-input" type="text" value="" placeholder="@handle" disabled>
                        <button class="btn wallet-edit-btn" type="button" data-edit="acctX">EDIT</button>
                    </div>

                    <div class="wallet-field-row">
                        <div class="wallet-field-label">T.ME</div>
                        <input id="acctTg" class="wallet-field-input" type="text" value="" placeholder="t.me/username" disabled>
                        <button class="btn wallet-edit-btn" type="button" data-edit="acctTg">EDIT</button>
                    </div>

                    <div class="wallet-avatar-row">
                        <div class="wallet-field-label" style="padding-top: 6px;">AVATAR</div>
                        <div class="wallet-avatar-meta">
                            <img id="acctAvatarPreview" class="wallet-avatar-preview" src="https://picsum.photos/seed/metamob-avatar/160" alt="Avatar preview" loading="lazy" />
                            <input id="acctAvatarFile" class="wallet-file-input" type="file" accept="image/*" style="display:none;" />
                            <button class="btn wallet-edit-btn" type="button" id="acctAvatarBtn">CHANGE</button>
                            <div class="wallet-avatar-hint">SELECT IMAGE ‚Üí PREVIEW. CLICK UPLOAD TO PIN TO IPFS.</div>
                            <div id="acctAvatarUrl" class="wallet-avatar-url"></div>
                        </div>
                    </div>
                `;
          openWalletModal('ACCOUNT', html);

          // Wire edit/save behavior after modal is injected
          setTimeout(() => {
            const body = document.getElementById('walletActionBody');
            if (!body) return;

            const toggleField = (inputId, btn) => {
              const el = document.getElementById(inputId);
              if (!el) return;
              const isDisabled = el.disabled;
              if (isDisabled) {
                el.disabled = false;
                el.focus();
                btn.textContent = 'SAVE';
              } else {
                el.disabled = true;
                btn.textContent = 'EDIT';
                // persist to localStorage
                localStorage.setItem(`metamob_profile_${inputId}`, el.value);
              }
            };

            // restore saved values
            ['acctName', 'acctEmail', 'acctPhone', 'acctX', 'acctTg'].forEach((id) => {
              const el = document.getElementById(id);
              if (!el) return;
              el.value = localStorage.getItem(`metamob_profile_${id}`) || '';
            });
            const pfx = document.getElementById('acctPhonePrefix');
            if (pfx) pfx.value = localStorage.getItem('metamob_profile_acctPhonePrefix') || '+44';

            body.querySelectorAll('button[data-edit]').forEach((btn) => {
              btn.addEventListener('click', () => toggleField(btn.dataset.edit, btn));
            });

            // phone: enable both prefix + phone
            body.querySelectorAll('button[data-edit-phone]').forEach((btn) => {
              btn.addEventListener('click', () => {
                const phone = document.getElementById(btn.dataset.editPhone);
                const prefix = document.getElementById('acctPhonePrefix');
                const isDisabled = phone ? phone.disabled : true;
                if (phone) phone.disabled = !isDisabled;
                if (prefix) prefix.disabled = !isDisabled;
                if (!isDisabled) {
                  // saving
                  if (phone) localStorage.setItem('metamob_profile_acctPhone', phone.value);
                  if (prefix) localStorage.setItem('metamob_profile_acctPhonePrefix', prefix.value);
                  btn.textContent = 'EDIT';
                } else {
                  btn.textContent = 'SAVE';
                  if (phone) phone.focus();
                }
              });
            });

            // Avatar upload flow (no edit/save toggle)
            const avatarPreview = document.getElementById('acctAvatarPreview');
            const avatarFile = document.getElementById('acctAvatarFile');
            const avatarBtn = document.getElementById('acctAvatarBtn');
            const avatarUrlEl = document.getElementById('acctAvatarUrl');

            // restore saved avatar url
            const savedAvatarUrl = localStorage.getItem('metamob_profile_avatarUrl') || '';
            if (savedAvatarUrl && avatarPreview) {
              avatarPreview.src = savedAvatarUrl;
              if (avatarUrlEl) {
                avatarUrlEl.style.display = 'block';
                avatarUrlEl.textContent = savedAvatarUrl;
              }
            }

            let pendingAvatarFile = null;

            function setAvatarButtonState(state) {
              if (!avatarBtn) return;
              if (state === 'change') avatarBtn.textContent = 'CHANGE';
              if (state === 'upload') avatarBtn.textContent = 'UPLOAD';
              if (state === 'uploading') avatarBtn.textContent = 'UPLOADING‚Ä¶';
            }

            // basic IPFS upload helper (public gateways are read-only; we try common public pin endpoints)
            async function uploadToIpfs(file) {
              // NOTE: Many public gateways do NOT allow uploads from the browser.
              // We attempt a few public endpoints. If they fail, we throw an error.
              const formData = new FormData();
              formData.append('file', file);

              const endpoints = [
                // public-ipfs is often CORS-restricted; keep as best-effort
                {url: 'https://ipfs.infura.io:5001/api/v0/add?pin=true', mode: 'cors'},
                {url: 'https://api.web3.storage/upload', mode: 'cors'},
                {url: 'https://nft.storage/upload', mode: 'cors'},
              ];

              let lastErr = null;
              for (const ep of endpoints) {
                try {
                  const resp = await fetch(ep.url, {
                    method: 'POST',
                    body: file,
                    mode: ep.mode,
                    headers:
                      ep.url.includes('web3.storage') || ep.url.includes('nft.storage')
                        ? {
                            // These services require API keys; without one they will fail.
                            // We keep the code to plug in keys later.
                          }
                        : undefined,
                  });

                  if (!resp.ok) {
                    const t = await resp.text().catch(() => '');
                    throw new Error(`${resp.status} ${resp.statusText} ${t}`);
                  }

                  // Try parse JSON responses
                  const ct = resp.headers.get('content-type') || '';
                  if (ct.includes('application/json')) {
                    const data = await resp.json();
                    // web3.storage / nft.storage: { cid: "..." }
                    if (data && data.cid) return data.cid;
                    // infura add often returns newline JSON (not always correct when fetched)
                    if (data && (data.Hash || data.hash)) return data.Hash || data.hash;
                  }

                  // fallback: try parse as text
                  const raw = await resp.text();
                  // ipfs add sometimes returns: {"Name":"...","Hash":"CID","Size":"..."}
                  const m = raw.match(/"Hash"\s*:\s*"([^"]+)"/);
                  if (m) return m[1];
                  const m2 = raw.match(/"cid"\s*:\s*"([^"]+)"/);
                  if (m2) return m2[1];

                  throw new Error('Unknown upload response format');
                } catch (e) {
                  lastErr = e;
                }
              }
              throw lastErr || new Error('IPFS upload failed');
            }

            if (avatarBtn && avatarFile) {
              setAvatarButtonState('change');

              avatarBtn.addEventListener('click', async () => {
                // If no file selected yet: open picker
                if (!pendingAvatarFile) {
                  avatarFile.click();
                  return;
                }

                // If file selected: upload
                try {
                  setAvatarButtonState('uploading');
                  const cid = await uploadToIpfs(pendingAvatarFile);
                  const gatewayUrl = `https://ipfs.io/ipfs/${cid}`;

                  if (avatarPreview) avatarPreview.src = gatewayUrl;
                  if (avatarUrlEl) {
                    avatarUrlEl.style.display = 'block';
                    avatarUrlEl.textContent = gatewayUrl;
                  }

                  localStorage.setItem('metamob_profile_avatarUrl', gatewayUrl);
                  pendingAvatarFile = null;
                  setAvatarButtonState('change');
                  showToast('AVATAR UPLOADED');
                } catch (e) {
                  console.error('[AVATAR] Upload failed:', e);
                  pendingAvatarFile = null;
                  setAvatarButtonState('change');
                  alert('IPFS upload failed. This demo needs a pinning service API key or backend.');
                }
              });

              avatarFile.addEventListener('change', () => {
                const f = avatarFile.files && avatarFile.files[0];
                if (!f) return;
                pendingAvatarFile = f;
                // preview local selection
                const objUrl = URL.createObjectURL(f);
                if (avatarPreview) avatarPreview.src = objUrl;
                if (avatarUrlEl) {
                  avatarUrlEl.style.display = 'block';
                  avatarUrlEl.textContent = 'LOCAL PREVIEW (NOT UPLOADED YET)';
                }
                setAvatarButtonState('upload');
              });
            }
          }, 0);
          return;
        }

        if (action === 'settings') {
          const html = `
                    <div class="wallet-metrics">
                        <div class="wallet-metric">
                            <div class="label">NETWORK MODE</div>
                            <div class="value">${network}</div>
                        </div>
                        <div class="wallet-metric">
                            <div class="label">GAS STRATEGY</div>
                            <div class="value">SMART</div>
                        </div>
                    </div>

                    <div class="wallet-list">
                        <li>
                            <span>COLOR PREFERENCE</span>
                            <span>
                                <select id="settingsThemeSelect" class="wallet-prefix-select">
                                    <option value="0">Dark Void</option>
                                    <option value="1">Matrix</option>
                                    <option value="2">Light Gothic</option>
                                </select>
                            </span>
                        </li>
                        <li>
                            <span>CHAIN PREFERENCE</span>
                            <span>
                                <select id="settingsChainSelect" class="wallet-prefix-select">
                                    <option value="Base">Base</option>
                                    <option value="Linea">Linea</option>
                                    <option value="Monad">Monad</option>
                                    <option value="Polygon">Polygon</option>
                                    <option value="Solana">Solana</option>
                                    <option value="zkSync">zkSync</option>
                                </select>
                            </span>
                        </li>
                        <li>
                            <span>AUTO-CONNECT</span>
                            <span><input id="settingsAutoConnect" type="checkbox" checked></span>
                        </li>
                        <li>
                            <span>NOTIFICATIONS</span>
                            <span>
                                <select id="settingsNotifications" class="wallet-prefix-select">
                                    <option value="all">All</option>
                                    <option value="critical">Critical Only</option>
                                    <option value="none">None</option>
                                </select>
                            </span>
                        </li>
                        <li><span>DEFAULT WALLET</span><span>MetaMask</span></li>
                    </div>

                    <div class="wallet-actions">
                        <button class="btn" type="button" id="settingsSaveBtn">SAVE PREFS</button>
                        <button class="btn" type="button" id="settingsResetBtn">RESET</button>
                    </div>
                `;
          openWalletModal('WALLET SETTINGS', html);

          // wire up controls after inject
          setTimeout(() => {
            const themeSelect = document.getElementById('settingsThemeSelect');
            const chainSelect = document.getElementById('settingsChainSelect');
            const autoConnectEl = document.getElementById('settingsAutoConnect');
            const notifEl = document.getElementById('settingsNotifications');
            const saveBtn = document.getElementById('settingsSaveBtn');
            const resetBtn = document.getElementById('settingsResetBtn');

            // Restore from storage (fallback to current UI state)
            const savedTheme = localStorage.getItem('metamob_pref_theme');
            const savedChain = localStorage.getItem('metamob_pref_chain');
            const savedAuto = localStorage.getItem('metamob_pref_autoconnect');
            const savedNotif = localStorage.getItem('metamob_pref_notifications');

            if (themeSelect) themeSelect.value = savedTheme !== null ? String(savedTheme) : String(currentPalette);
            if (chainSelect) chainSelect.value = savedChain || network;
            if (autoConnectEl) autoConnectEl.checked = savedAuto !== null ? savedAuto === 'true' : true;
            if (notifEl) notifEl.value = savedNotif || 'all';

            // Live preview only (no persistence until SAVE PREFS)
            if (themeSelect) {
              themeSelect.addEventListener('change', (e) => {
                const val = e.target.value;
                if (typeof syncSliders === 'function') syncSliders(val);
              });
            }

            if (chainSelect) {
              chainSelect.addEventListener('change', async (e) => {
                const newNet = e.target.value;
                if (typeof switchNetwork === 'function') await switchNetwork(newNet);
                // update visible labels immediately
                document.getElementById('currentNetwork').textContent = newNet;
                document.getElementById('mobileCurrentNetwork').textContent = newNet;
              });
            }

            if (saveBtn) {
              saveBtn.addEventListener('click', () => {
                // Persist settings
                if (themeSelect) localStorage.setItem('metamob_pref_theme', String(themeSelect.value));
                if (chainSelect) localStorage.setItem('metamob_pref_chain', String(chainSelect.value));
                if (autoConnectEl) localStorage.setItem('metamob_pref_autoconnect', String(autoConnectEl.checked));
                if (notifEl) localStorage.setItem('metamob_pref_notifications', String(notifEl.value));

                showToast('PREFERENCES SECURED');
                closeWalletModal();
              });
            }

            if (resetBtn) {
              resetBtn.addEventListener('click', async () => {
                localStorage.removeItem('metamob_pref_theme');
                localStorage.removeItem('metamob_pref_chain');
                localStorage.removeItem('metamob_pref_autoconnect');
                localStorage.removeItem('metamob_pref_notifications');

                if (themeSelect) themeSelect.value = '0';
                if (notifEl) notifEl.value = 'all';
                if (autoConnectEl) autoConnectEl.checked = true;
                if (chainSelect) chainSelect.value = 'Base';

                if (typeof syncSliders === 'function') syncSliders('0');
                if (typeof switchNetwork === 'function') await switchNetwork('Base');
                document.getElementById('currentNetwork').textContent = 'Base';
                document.getElementById('mobileCurrentNetwork').textContent = 'Base';

                showToast('RESET COMPLETE');
              });
            }
          }, 0);

          return;
        }

        if (action === 'chat') {
          const html = `
                    <div class="wallet-metrics">
                        <div class="wallet-metric">
                            <div class="label">CHAT MODULE</div>
                            <div class="value">COMING SOON</div>
                        </div>
                    </div>
                    <p class="detail-text" style="margin-top:10px; text-transform:none;">
                        Encrypted live operations chat will be available here. You will be able to open secure channels with the METAMOB desk directly from this interface.
                    </p>
                `;
          openWalletModal('LIVE OPERATIONS CHAT', html);
          return;
        }

        if (action === 'wallet') {
          const ETHERSCAN_KEY = 'FVBIGB5F74IAC4FA1VE74I52FS3CBKIVYI';
          const address = walletState.address;

          if (!address) {
            openWalletModal('WALLET OVERLAY', '<p class="detail-text">Please connect your wallet to view portfolio.</p>');
            return;
          }

          // Determine active chain from wallet (not just UI text)
          const chainId = walletState.chainId;
          const chainIdToKey = {
            1: 'Ethereum', // mainnet
            137: 'Polygon', // Polygon
            0x89: 'Polygon', // alt hex
            8453: 'Base', // Base mainnet
            0x2105: 'Base',
            59144: 'Linea', // Linea mainnet
            0xe708: 'Linea',
            324: 'zkSync', // zkSync Era
            0x144: 'zkSync',
          };

          const chainKey = chainIdToKey[chainId] || 'Ethereum';

          // Per-chain config: explorer API + native + tracked ERC‚Äë20s
          const NETWORKS = {
            Ethereum: {
              name: 'Ethereum',
              apiUrl: 'https://api.etherscan.io/api',
              nativeSymbol: 'ETH',
              nativeDecimals: 18,
              tokens: {
                USDC: {
                  address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606EB48',
                  decimals: 6,
                },
                USDT: {
                  address: '0xdAC17F958D2ee523a2206206994597C13D831ec7',
                  decimals: 6,
                },
                WETH: {
                  address: '0xC02aaA39b223FE8D0a0e5C4f27eAD9083C756Cc2',
                  decimals: 18,
                },
                WBTC: {
                  address: '0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599',
                  decimals: 8,
                },
              },
            },
            Polygon: {
              name: 'Polygon',
              apiUrl: 'https://api.polygonscan.com/api',
              nativeSymbol: 'MATIC',
              nativeDecimals: 18,
              tokens: {
                USDC: {
                  address: '0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174',
                  decimals: 6,
                },
                USDT: {
                  address: '0xc2132D05D31c914a87C6611C10748AEb04B58e8F',
                  decimals: 6,
                },
                WETH: {
                  address: '0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619',
                  decimals: 18,
                },
                WBTC: {
                  address: '0x1BFD67037B42Cf73acF2047067bd4F2C47D9BfD6',
                  decimals: 8,
                },
              },
            },
            Base: {
              name: 'Base',
              apiUrl: 'https://api.basescan.org/api',
              nativeSymbol: 'ETH',
              nativeDecimals: 18,
              tokens: {}, // token mapping can be added when addresses are finalized
            },
            Linea: {
              name: 'Linea',
              apiUrl: 'https://api.lineascan.build/api',
              nativeSymbol: 'ETH',
              nativeDecimals: 18,
              tokens: {}, // token mapping TBD
            },
            zkSync: {
              name: 'zkSync Era',
              apiUrl: 'https://api-era.zksync.network/api',
              nativeSymbol: 'ETH',
              nativeDecimals: 18,
              tokens: {}, // token mapping TBD
            },
          };

          const cfg = NETWORKS[chainKey] || NETWORKS.Ethereum;

          const loadingHtml = `
                    <div class="wallet-metrics">
                        <div class="wallet-metric"><div class="label">STATUS</div><div class="value">SCANNING...</div></div>
                    </div>
                    <p class="detail-text" style="margin-top:10px;">Accessing ${cfg.name} via Etherscan API‚Ä¶</p>
                `;
          openWalletModal('WALLET OVERLAY', loadingHtml);

          async function fetchPortfolio() {
            try {
              // 1) Native balance (gas token)
              let nativeBal = '0.0000';
              try {
                const nativeResp = await fetch(`${cfg.apiUrl}?module=account&action=balance&address=${address}&tag=latest&apikey=${ETHERSCAN_KEY}`);
                const nativeData = await nativeResp.json();
                if (nativeData.status === '1') {
                  const raw = Number(nativeData.result || '0');
                  nativeBal = (raw / Math.pow(10, cfg.nativeDecimals)).toFixed(4);
                }
              } catch (e) {
                console.warn('[WALLET] Native balance fetch failed:', e);
              }

              // 2) Tracked ERC‚Äë20s (USDC, USDT, WETH, WBTC)
              const tokenEntries = Object.entries(cfg.tokens || {});
              let tokenHtml = '';

              if (tokenEntries.length) {
                const tokenPromises = tokenEntries.map(([symbol, meta]) =>
                  fetch(`${cfg.apiUrl}?module=account&action=tokenbalance&contractaddress=${meta.address}&address=${address}&tag=latest&apikey=${ETHERSCAN_KEY}`)
                    .then((r) => r.json())
                    .catch(() => null)
                );

                const results = await Promise.all(tokenPromises);

                results.forEach((res, idx) => {
                  if (!res || res.status !== '1') return;
                  const [symbol, meta] = tokenEntries[idx];
                  const raw = Number(res.result || '0');
                  const val = raw / Math.pow(10, meta.decimals);
                  if (val > 0) {
                    const formatted = val.toFixed(4);
                    tokenHtml += `<li><span>${symbol}</span><span>${formatted}</span></li>`;
                  }
                });
              }

              const assetsHtml = tokenHtml || '<li><span>NO TRACKED TOKENS FOUND</span><span>0.00</span></li>';

              const finalHtml = `
                            <div class="wallet-metrics">
                                <div class="wallet-metric">
                                    <div class="label">NATIVE BALANCE</div>
                                    <div class="value">${nativeBal} ${cfg.nativeSymbol}</div>
                                </div>
                                <div class="wallet-metric">
                                    <div class="label">NETWORK</div>
                                    <div class="value">${cfg.name.toUpperCase()}</div>
                                </div>
                            </div>
                            <div class="detail-sub" style="margin-top:15px; margin-bottom:8px;">ASSETS ON CHAIN (ETH, USDC, USDT, WETH, WBTC)</div>
                            <div class="wallet-list">
                                ${assetsHtml}
                            </div>
                            <div class="wallet-actions" style="margin-top:15px;">
                                <button class="btn" type="button" onclick="showToast('SENDING INITIATED')">SEND</button>
                                <button class="btn" type="button" onclick="showToast('RECEIVE ADDRESS COPIED')">RECEIVE</button>
                            </div>
                        `;

              const bodyEl = document.getElementById('walletActionBody');
              if (bodyEl) bodyEl.innerHTML = finalHtml;
            } catch (err) {
              console.error('[WALLET] Portfolio fetch error:', err);
              const bodyEl = document.getElementById('walletActionBody');
              if (bodyEl) bodyEl.innerHTML = '<p class="detail-text">Failed to fetch data from Etherscan-compatible API. Please verify network support.</p>';
            }
          }

          fetchPortfolio();
          return;
        }
      }

      function openProductDetail(categoryKey, variantId) {
        const cat = PRODUCT_CATALOG[categoryKey];
        if (!cat) return;
        const v = cat.variants.find((x) => x.id === variantId);
        if (!v) return;

        if (productDetailKicker) productDetailKicker.textContent = cat.display;
        if (productDetailTitle) productDetailTitle.textContent = v.name;
        if (productDetailImage) {
          productDetailImage.src = v.image;
          productDetailImage.alt = v.name;
        }
        if (productDetailStory) productDetailStory.textContent = v.story;
        if (productDetailCategory) productDetailCategory.textContent = cat.category;
        if (productDetailPrice) productDetailPrice.textContent = v.price;
        if (productDetailDescription) productDetailDescription.textContent = v.desc;

        if (productDetailSpecs) {
          productDetailSpecs.innerHTML = '';
          v.specs.forEach((s) => {
            const li = document.createElement('li');
            li.textContent = `‚Ä¢ ${s}`;
            productDetailSpecs.appendChild(li);
          });
        }

        if (productDetailFootnote) {
          productDetailFootnote.textContent = `Network: ${document.getElementById('currentNetwork')?.textContent || 'Base'} | Wallet: ${isConnected ? 'CONNECTED' : 'DISCONNECTED'}`;
        }

        if (productDetailBuyBtn) {
          productDetailBuyBtn.textContent = cat.display.includes('SERVER') ? 'RENT NOW' : cat.display.includes('NFT') ? 'MINT NOW' : 'BUY NOW';
          productDetailBuyBtn.onclick = () => showToast(`TX SIMULATED: ${v.name}`);
        }

        closeOverlay(productVariantsOverlay);
        openOverlay(productDetailOverlay);
      }

      function wireProductOverlays() {
        if (productVariantsClose) productVariantsClose.addEventListener('click', () => closeOverlay(productVariantsOverlay));
        if (productVariantsOverlay) {
          productVariantsOverlay.addEventListener('click', (e) => {
            if (e.target === productVariantsOverlay) closeOverlay(productVariantsOverlay);
          });
        }

        if (productDetailClose) productDetailClose.addEventListener('click', () => closeOverlay(productDetailOverlay));
        if (productDetailBackBtn)
          productDetailBackBtn.addEventListener('click', () => {
            closeOverlay(productDetailOverlay);
            if (lastVariantsCategoryKey) openVariants(lastVariantsCategoryKey);
          });
        if (productDetailOverlay) {
          productDetailOverlay.addEventListener('click', (e) => {
            if (e.target === productDetailOverlay) closeOverlay(productDetailOverlay);
          });
        }
      }

      // Make overlays theme-aware
      function applyProductModalTheme(palette) {
        const overlays = [productVariantsModal, productDetail];
        overlays.forEach((el) => {
          if (!el) return;
          el.style.setProperty('--bg-color', palette.background);
          el.style.background = palette.background;
          el.style.borderColor = palette.accent + '55';
        });
      }

      // Wire up after DOM is ready (script is at end, so safe)
      ensureShopCardsInteractive();
      wireProductOverlays();

      // ============================================
      // SETTINGS: RESTORE ON LOAD (PERSIST LIKE ACCOUNT)
      // ============================================
      function restoreSettingsOnLoad() {
        const savedTheme = localStorage.getItem('metamob_pref_theme');
        const savedChain = localStorage.getItem('metamob_pref_chain');
        const savedAuto = localStorage.getItem('metamob_pref_autoconnect');

        // Theme
        if (savedTheme !== null) {
          console.log('[SETTINGS] Restoring theme:', savedTheme);
          syncSliders(savedTheme);
        } else {
          syncSliders('0');
        }

        // Chain label + optional switch
        if (savedChain) {
          console.log('[SETTINGS] Restoring chain preference:', savedChain);
          const cur = document.getElementById('currentNetwork');
          const mobCur = document.getElementById('mobileCurrentNetwork');
          if (cur) cur.textContent = savedChain;
          if (mobCur) mobCur.textContent = savedChain;

          // If autoconnect is disabled, don't force switch at load
          const shouldSwitch = savedAuto === null ? true : savedAuto === 'true';
          if (shouldSwitch && typeof switchNetwork === 'function') {
            switchNetwork(savedChain);
          }
        }
      }

      // Initialize
      restoreSettingsOnLoad();
      // Ensure shop cards are interactive after initial paint
      ensureShopCardsInteractive();
    </script>
  </body>
</html>
